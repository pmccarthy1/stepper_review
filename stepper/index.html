<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sequoia Stepper Component â€“ Stakeholder Prototype</title>
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --blue-primary: #0061f4;
      --step-accent:  var(--blue-primary); /* swapped by .theme-black */
      --white: #ffffff;
      --gray-100: #f2f2f2;
      --gray-200: #e0e0e0;
      --gray-400: #ababab;
      --gray-600: #6b6b6b;
      --gray-900: #281805;
      --dot-size: 32px;
      --dot-size-sm: 24px;
      --line-thickness: 4px;
      --radius: 50%;
      --step-gap: 0px;
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      font-family: var(--font);
      background: #F0F2F5;
      color: var(--gray-900);
      min-height: 100vh;
      padding: 0;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 20px 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
    }
    .page-header h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }
    .page-header .badge {
      font-size: 11px;
      font-weight: 600;
      background: var(--blue-light);
      color: var(--blue-primary);
      padding: 3px 10px;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: .5px;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-body {
      max-width: 1100px;
      margin: 0 auto;
      padding: 48px 24px 80px;
      display: flex;
      flex-direction: column;
      gap: 48px;
    }

    /* â”€â”€ Section Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-card {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      overflow: hidden;
    }
    .section-header {
      padding: 20px 32px 16px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .section-header h2 {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: .8px;
    }
    .section-header .variant-tag {
      font-size: 11px;
      background: var(--gray-100);
      color: var(--gray-600);
      padding: 2px 8px;
      border-radius: 4px;
    }
    .section-body {
      padding: 40px 32px 48px;
    }

    /* â”€â”€ Tab Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-nav {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--gray-200);
      margin-bottom: 40px;
    }
    .tab-btn {
      background: none;
      border: none;
      padding: 10px 24px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-400);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: color .15s, border-color .15s;
    }
    .tab-btn.active {
      color: var(--blue-primary);
      border-bottom-color: var(--blue-primary);
      font-weight: 600;
    }
    .tab-btn:hover:not(.active) { color: var(--gray-600); }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HORIZONTAL STEPPER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .h-stepper-wrap {
      display: flex;
      flex-direction: column;
      gap: 48px;
    }

    /* interactive demo wrapper */
    .demo-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }
    .demo-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--gray-400);
      font-weight: 600;
      align-self: flex-start;
    }

    /* the stepper track */
    .h-stepper {
      display: flex;
      align-items: flex-start;
      width: 100%;
    }

    .h-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
      cursor: pointer;
    }

    /* connector line between steps */
    .h-step-track {
      display: flex;
      align-items: center;
      width: 100%;
      position: relative;
    }
    .h-step-track::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: var(--line-thickness);
      background: var(--gray-200);
      transform: translateY(-50%);
      z-index: 0;
    }

    .h-step-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    /* Lines between dots */
    .h-connector {
      flex: 1;
      height: var(--line-thickness);
      background: var(--gray-200);
      position: relative;
      margin-top: calc(var(--dot-size) / 2 - var(--line-thickness) / 2);
      transition: background .3s;
    }
    .h-connector.complete { background: var(--step-accent); }

    /* Dot */
    .h-dot {
      width: var(--dot-size);
      height: var(--dot-size);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
      transition: all .2s;
      font-size: 14px;
      font-weight: 600;
    }

    /* Incomplete - light grey fill, dark number */
    .h-dot.incomplete {
      background: #E0E0E0;
      border: 4px solid #E0E0E0;
      color: #281805;
    }

    /* Current - solid accent fill, white step number */
    .h-dot.current {
      background: var(--step-accent);
      border: 4px solid var(--step-accent);
      color: white;
    }

    /* Complete - accent fill, white checkmark */
    .h-dot.complete {
      background: var(--step-accent);
      border: 4px solid var(--step-accent);
      color: var(--white);
    }

    /* Step label */
    .h-label {
      font-size: 12px;
      font-weight: 400;
      color: #281805;
      white-space: nowrap;
      text-align: center;
      transition: color .2s, font-weight .2s;
    }
    .h-step.is-current .h-label {
      color: #281805;
      font-weight: 700;
    }
    .h-step.is-complete .h-label { color: #281805; }

    /* Checkmark SVG */
    .check-icon {
      width: 16px;
      height: 16px;
      stroke: white;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    /* Partly complete - accent fill with white dash */
    .h-dot.partly-complete {
      background: var(--step-accent);
      border: 4px solid var(--step-accent);
      color: white;
    }
    .h-step.is-partly-complete .h-label { color: #281805; }

    /* â”€â”€ Icon swap: normal icon vs pencil on hover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dot-normal { display: flex; align-items: center; justify-content: center; }
    .dot-pencil { display: none; align-items: center; justify-content: center; }

    /* â”€â”€ Hoverable steps: complete + partly-complete ONLY â”€â”€â”€â”€â”€â”€ */
    .h-step.is-hoverable { cursor: pointer; }
    /* Fill colour does not change on hover â€” only pencil icon swaps in */
    .h-step.is-hoverable:hover .dot-normal { display: none; }
    .h-step.is-hoverable:hover .dot-pencil { display: flex; }
    .h-step.is-hoverable:hover .h-label {
      text-decoration: underline;
      color: var(--gray-900);
    }

    /* â”€â”€ Tooltip on step dots via data-tip attribute â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .h-dot[data-tip], .v-dot[data-tip] { position: relative; }
    .h-dot[data-tip]::before, .v-dot[data-tip]::before {
      content: attr(data-tip);
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: #212121;
      color: #fff;
      border-radius: 4px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s;
      z-index: 200;
    }
    .h-dot[data-tip]:hover::before, .v-dot[data-tip]:hover::before { opacity: 1; }

    /* â”€â”€ Future / incomplete steps â€” no pointer, no hover â”€â”€â”€â”€â”€â”€ */
    .h-step.is-future {
      cursor: default;
      pointer-events: none;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SAVE & CONTINUE MODAL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s;
    }
    .modal-overlay.visible {
      opacity: 1;
      pointer-events: all;
    }
    .modal {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,.18);
      padding: 32px;
      max-width: 420px;
      width: 90%;
      transform: translateY(12px);
      transition: transform .2s;
    }
    .modal-overlay.visible .modal { transform: translateY(0); }
    .modal-icon {
      width: 44px; height: 44px;
      border-radius: 50%;
      background: #FFF8E1;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 16px;
      font-size: 22px;
    }
    .modal h3 {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 8px;
    }
    .modal p {
      font-size: 14px;
      color: var(--gray-600);
      line-height: 1.6;
      margin-bottom: 24px;
    }
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* â”€â”€ Navigation buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .nav-row {
      display: flex;
      gap: 12px;
      justify-content: space-between;
      width: 100%;
      margin-top: 32px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 12px 24px;
      height: 48px;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background .15s, opacity .15s, border-color .15s;
      border: none;
      white-space: nowrap;
    }
    .btn-primary {
      background: #281805;
      color: var(--white);
      border: none;
    }
    .btn-primary:hover { background: #3d2508; }
    .btn-secondary {
      background: var(--white);
      color: #281805;
      border: 2px solid #281805;
    }
    .btn-secondary:hover { background: #f5f0eb; }
    .btn:disabled { opacity: .4; cursor: not-allowed; pointer-events: none; }

    /* Step form panel */
    .step-form-panel {
      margin-top: 20px;
      border: 1.5px solid var(--gray-200);
      border-radius: 10px;
      padding: 20px 24px 24px;
      background: white;
    }
    .step-form-panel h4 {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-200);
    }
    .step-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-width: 480px;
    }
    .step-form .field-group { display: flex; flex-direction: column; gap: 5px; }
    .step-form .field-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-900);
    }
    .step-form .req-mark { color: #E53935; margin-left: 2px; }
    .step-form input[type=text],
    .step-form input[type=email],
    .step-form input[type=tel],
    .step-form select {
      height: 40px;
      padding: 0 12px;
      border: 1.5px solid var(--gray-200);
      border-radius: 6px;
      font-size: 14px;
      color: var(--gray-900);
      background: white;
      width: 100%;
      transition: border-color .15s;
    }
    .step-form input:focus, .step-form select:focus {
      outline: none;
      border-color: var(--blue-primary);
      box-shadow: 0 0 0 3px rgba(0,87,255,.1);
    }
    .step-form input.field-error, .step-form select.field-error {
      border-color: #E53935;
      box-shadow: 0 0 0 3px rgba(229,57,53,.1);
    }
    .step-form .field-error-msg {
      font-size: 11px;
      color: #E53935;
      margin-top: 2px;
    }
    .step-form .check-row {
      display: flex;
      align-items: center;
      gap: 9px;
      cursor: pointer;
      font-size: 14px;
      color: var(--gray-900);
    }
    .step-form .check-row input[type=checkbox] {
      width: 16px;
      height: 16px;
      accent-color: var(--blue-primary);
      flex-shrink: 0;
      cursor: pointer;
    }
    .step-form .field-hint {
      font-size: 11px;
      color: var(--gray-400);
    }
    .step-form-empty {
      padding: 32px;
      text-align: center;
      color: var(--gray-400);
      font-size: 13px;
      background: var(--gray-100);
      border-radius: 8px;
      border: 1.5px dashed var(--gray-200);
    }

    /* Step count control */
    .controls-row {
      display: flex;
      align-items: center;
      gap: 16px;
      background: var(--gray-100);
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 13px;
      color: var(--gray-600);
    }
    .controls-row label { font-weight: 600; }
    .step-count-btn {
      width: 28px; height: 28px;
      border-radius: 50%;
      border: 1.5px solid var(--gray-200);
      background: var(--white);
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-600);
      transition: border-color .15s;
    }
    .step-count-btn:hover { border-color: var(--blue-primary); color: var(--blue-primary); }
    .step-count-val { font-weight: 700; color: var(--gray-900); min-width: 20px; text-align: center; }

    /* progress info */
    .progress-chip {
      font-size: 12px;
      background: var(--blue-light);
      color: var(--blue-primary);
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VERTICAL STEPPER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .v-stepper {
      display: flex;
      flex-direction: column;
    }

    .v-step {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      cursor: pointer;
      position: relative;
    }

    .v-step-aside {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
    }

    .v-dot {
      width: var(--dot-size);
      height: var(--dot-size);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
      font-size: 13px;
      font-weight: 700;
      transition: all .2s;
    }
    .v-dot.incomplete {
      background: #E0E0E0;
      border: 4px solid #E0E0E0;
      color: #281805;
    }
    .v-dot.current {
      background: var(--step-accent);
      border: 4px solid var(--step-accent);
      color: white;
    }
    .v-dot.complete {
      background: var(--step-accent);
      border: 4px solid var(--step-accent);
      color: var(--white);
    }
    .v-dot.partly-complete {
      background: var(--step-accent);
      border: 4px solid var(--step-accent);
      color: white;
      font-weight: 700;
    }

    /* â”€â”€ Vertical hoverable steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .v-step.is-hoverable { cursor: pointer; }
    /* Fill colour does not change on hover â€” only pencil icon swaps in */
    .v-step.is-hoverable:hover .dot-normal { display: none; }
    .v-step.is-hoverable:hover .dot-pencil { display: flex; }
    .v-step.is-hoverable:hover .v-step-title {
      text-decoration: underline;
      color: var(--gray-900);
    }
    .v-step.is-future { cursor: default; pointer-events: none; }
    .v-step.is-partly-complete .v-step-title { color: var(--gray-600); }

    /* vertical connector line */
    .v-line {
      width: var(--line-thickness);
      flex: 1;
      min-height: 40px;
      background: var(--gray-200);
      border-radius: 2px;
      transition: background .3s;
    }
    .v-line.complete { background: var(--step-accent); }

    /* step body (title + description) */
    .v-step-body {
      padding-top: 4px;
      padding-bottom: 40px;
      flex: 1;
    }
    .v-step:last-child .v-step-body { padding-bottom: 0; }

    .v-step-title {
      font-size: 14px;
      font-weight: 400;
      color: #281805;
      transition: color .2s;
    }
    .v-step.is-current .v-step-title { color: #281805; font-weight: 700; }
    .v-step.is-complete .v-step-title { color: #281805; }
    .v-step.is-partly-complete .v-step-title { color: #281805; }

    .v-step-desc {
      margin-top: 6px;
      font-size: 13px;
      color: var(--gray-400);
      line-height: 1.5;
      max-height: 0;
      overflow: hidden;
      transition: max-height .3s ease, opacity .3s;
      opacity: 0;
    }
    .v-step.is-current .v-step-desc {
      max-height: 200px;
      opacity: 1;
    }

    /* â”€â”€ Content area (step form / panel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .step-panel {
      background: var(--gray-100);
      border: 1.5px solid var(--gray-200);
      border-radius: 8px;
      padding: 16px 20px;
      margin-top: 12px;
      font-size: 13px;
      color: var(--gray-600);
      line-height: 1.6;
    }
    .step-panel-nav {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    /* â”€â”€ Showcase grid of static states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .states-grid {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      align-items: flex-start;
    }
    .state-demo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .state-demo .state-dot {
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
    }
    .state-dot.s-incomplete {
      background: var(--white);
      border: 2px solid var(--gray-200);
      color: var(--gray-400);
    }
    .state-dot.s-current {
      background: white;
      border: 2px solid var(--blue-primary);
      box-shadow: none;
      color: var(--blue-primary);
      position: relative;
    }
    .state-dot.s-current::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--blue-primary);
    }
    /* Numeral current: solid blue fill + white number, no center dot */
    .state-dot.s-current-num {
      background: var(--blue-primary);
      border: 2px solid var(--blue-primary);
      box-shadow: none;
      color: white;
      font-size: 14px;
      font-weight: 700;
    }
    .state-dot.s-complete {
      background: var(--blue-primary);
      border: 2px solid var(--blue-primary);
      color: var(--white);
    }
    .state-label {
      font-size: 11px;
      color: var(--gray-400);
      text-align: center;
    }
    .divider {
      width: 1px;
      height: 48px;
      background: var(--gray-200);
      align-self: center;
    }
    .states-section-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: .8px;
      margin-bottom: 16px;
    }

    /* â”€â”€ Mobile stepper variant â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mobile-demo {
      max-width: 375px;
      border: 1.5px solid var(--gray-200);
      border-radius: 12px;
      overflow: hidden;
      background: var(--white);
    }
    .mobile-demo .app-bar {
      background: var(--blue-primary);
      height: 48px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      color: white;
      font-size: 16px;
      font-weight: 600;
    }
    .mobile-demo .mobile-body { padding: 24px 16px; }
    .mobile-demo .h-stepper { gap: 0; }
    .mobile-demo .h-dot {
      width: var(--dot-size-sm);
      height: var(--dot-size-sm);
      font-size: 11px;
    }
    .mobile-demo .h-connector { margin-top: calc(var(--dot-size-sm)/2 - var(--line-thickness)/2); }
    .mobile-demo .h-label { font-size: 10px; }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 680px) {
      .page-header { padding: 16px 20px; }
      .section-body { padding: 24px 16px 32px; }
      .h-label { font-size: 10px; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONDITIONAL STEPPER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .choice-grid {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .choice-card {
      flex: 1;
      min-width: 180px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      padding: 18px 20px;
      cursor: pointer;
      transition: border-color .15s, background .15s, transform .15s;
      background: var(--white);
      text-align: left;
    }
    .choice-card:hover {
      border-color: var(--blue-primary);
      background: #F0F5FF;
      transform: translateY(-2px);
    }
    .choice-card.selected {
      border-color: var(--blue-primary);
      background: #EAF1FF;
    }
    .choice-card .choice-icon { font-size: 24px; margin-bottom: 8px; }
    .choice-card .choice-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 4px;
    }
    .choice-card .choice-desc {
      font-size: 12px;
      color: var(--gray-600);
      line-height: 1.5;
    }
    .path-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 20px;
      background: #E0ECFE;
      color: var(--blue-primary);
      margin-bottom: 16px;
      transition: opacity .3s;
    }
    .path-tag.hidden { opacity: 0; }
    .path-tag .path-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--blue-primary);
    }
    .cond-step-new {
      animation: slideIn .3s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(8px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    .cond-step-content {
      border: 1.5px solid var(--gray-200);
      border-radius: 10px;
      padding: 20px 24px;
      background: white;
      margin-top: 20px;
    }
    .cond-step-content h4 {
      font-size: 14px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-200);
    }
    .cond-field-row {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 14px;
    }
    .cond-field-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-900);
    }
    .cond-field-input {
      height: 38px;
      padding: 0 12px;
      border: 1.5px solid var(--gray-200);
      border-radius: 6px;
      font-size: 14px;
      color: var(--gray-900);
      background: white;
      width: 100%;
      max-width: 440px;
    }
    .cond-field-select {
      height: 38px;
      padding: 0 12px;
      border: 1.5px solid var(--gray-200);
      border-radius: 6px;
      font-size: 14px;
      color: var(--gray-900);
      background: white;
      width: 100%;
      max-width: 440px;
    }
    .branch-changed-banner {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #FFF8E1;
      border: 1.5px solid #FFD54F;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 13px;
      color: #5D4037;
      margin-bottom: 16px;
      animation: slideIn .3s ease;
    }
    .branch-changed-banner.hidden { display: none; }

    /* â”€â”€ Spawned / internal-branch steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .h-dot.spawned { background:#6B48C8; border:4px solid #6B48C8; color:white; }
    .h-connector.spawned { background:#6B48C8; }
    .h-step.is-spawned .h-label { color:#4527A0 !important; }
    .spawn-pill {
      display:inline-flex; align-items:center; gap:5px;
      background:#EDE7FF; border:1px solid #B39DDB; color:#4527A0;
      border-radius:12px; padding:3px 10px; font-size:11px; font-weight:600;
      margin-bottom:12px;
    }
    .spawn-pill-dot { width:6px;height:6px;border-radius:50%;background:#6B48C8;flex-shrink:0; }
    .spawn-gate-banner {
      display:flex; align-items:center; gap:8px;
      background:#EDE7FF; border:1.5px solid #B39DDB; border-radius:8px;
      padding:10px 14px; font-size:13px; color:#4527A0;
      margin-bottom:14px; animation:slideIn .3s ease;
    }
    .spawn-gate-banner.hidden { display:none; }
    .branch-map-step { font-size:11px;background:#f2f2f2;padding:2px 8px;border-radius:4px;color:var(--gray-600); }
    .branch-map-step.spawned { background:#EDE7FF;color:#4527A0;border:1px solid #B39DDB; }
    .branch-trigger-tag {
      display:inline-flex; align-items:center; gap:3px;
      background:#FFF8E1; border:1px solid #FFD54F; color:#6D4C00;
      border-radius:10px; padding:2px 7px; font-size:10px; font-weight:600;
      margin-left:4px; vertical-align:middle;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BLACK THEME
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    body.theme-black {
      --step-accent: #281805; /* color/ğŸŒˆ-neutral/warm-black-850 */
    }

    /* Current dot in Black theme: white bg + dark ring + center dot (no solid fill) */
    body.theme-black .h-dot.current,
    body.theme-black .v-dot.current {
      background: white;
      border: 2.5px solid #281805;
    }
    body.theme-black .h-dot.current::after,
    body.theme-black .v-dot.current::after {
      content: '';
      position: absolute;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #281805;
      pointer-events: none;
    }
    /* Hide numeral in Current black (center dot replaces it) */
    body.theme-black .h-dot.current .dot-normal span,
    body.theme-black .v-dot.current .dot-normal span { visibility: hidden; }

    /* In Black theme, complete label is the same dark color as current (not gray-600) */
    body.theme-black .h-step.is-complete .h-label { color: var(--gray-900) !important; }
    body.theme-black .v-step.is-complete .v-step-title { color: var(--gray-900) !important; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       THEME TOGGLE PILL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .theme-toggle {
      display: flex;
      border: 1.5px solid var(--gray-200);
      border-radius: 20px;
      overflow: hidden;
    }
    .theme-toggle-btn {
      padding: 5px 14px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--gray-600);
      transition: all .15s;
      line-height: 1.4;
      white-space: nowrap;
    }
    .theme-toggle-btn.active {
      background: var(--gray-900);
      color: white;
      font-weight: 600;
    }
    .theme-toggle-btn:hover:not(.active) { background: var(--gray-100); }
  </style>
</head>
<body>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Page Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header class="page-header">
  <h1>Sequoia Design System &nbsp;Â·&nbsp; Stepper Component</h1>
  <div style="display:flex;align-items:center;gap:12px">
    <span style="font-size:12px;color:var(--gray-600);font-weight:500">Style:</span>
    <div class="theme-toggle" id="theme-toggle">
      <button class="theme-toggle-btn active" data-theme="rebrand">Rebrand</button>
      <button class="theme-toggle-btn" data-theme="black">Black</button>
    </div>
    <span class="badge">Stakeholder Review</span>
  </div>
</header>

<div class="page-body">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB NAV
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-nav">
    <button class="tab-btn active" data-tab="horizontal">Horizontal Stepper</button>
    <button class="tab-btn" data-tab="vertical">Vertical Stepper</button>
    <button class="tab-btn" data-tab="conditional">Conditional Logic</button>
    <button class="tab-btn" data-tab="states">Anatomy &amp; States</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 1 â€“ HORIZONTAL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-pane active" id="tab-horizontal">

    <!-- Interactive Demo -->
    <div class="section-card">
      <div class="section-header">
        <h2>Interactive Demo</h2>
        <span class="variant-tag theme-variant-tag">Rebrand Â· Core Blue</span>
      </div>
      <div class="section-body">

        <div class="demo-block">

          <!-- Controls -->
          <div class="controls-row">
            <label>Steps:</label>
            <button class="step-count-btn" id="h-dec">âˆ’</button>
            <span class="step-count-val" id="h-count-display">5</span>
            <button class="step-count-btn" id="h-inc">+</button>
            <span style="margin-left:8px">|</span>
            <span class="progress-chip" id="h-progress-chip">Step 1 of 5</span>
            <span id="h-saving-chip" style="opacity:0;transition:opacity .3s;font-size:12px;color:var(--gray-600);margin-left:4px">Savingâ€¦</span>
          </div>

          <!-- Stepper track -->
          <div style="width:100%">
            <div class="h-stepper" id="h-stepper-track"></div>
          </div>

          <!-- Step form content -->
          <div class="step-form-panel">
            <h4 id="h-step-form-title">Step</h4>
            <div id="h-step-form-body"></div>
          </div>

          <!-- Nav buttons -->
          <div class="nav-row">
            <button class="btn btn-secondary" id="h-back">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              Back
            </button>
            <button class="btn btn-primary" id="h-next">
              Next
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>
          <!-- Inline validation / submission message -->
          <div id="h-inline-error" style="display:none;margin-top:12px;padding:10px 14px;background:#FFF3F3;border:1.5px solid #F44336;border-radius:8px;font-size:13px;color:#B71C1C"></div>

        </div>
      </div>
    </div>

    <!-- Step count showcase -->
    <div class="section-card" style="margin-top:32px">
      <div class="section-header">
        <h2>Step Count Variants</h2>
        <span class="variant-tag">Static preview</span>
      </div>
      <div class="section-body">
        <div class="h-stepper-wrap" id="h-variants-wrap"></div>
      </div>
    </div>

    <!-- Mobile -->
    <div class="section-card" style="margin-top:32px">
      <div class="section-header">
        <h2>Mobile Breakpoint</h2>
        <span class="variant-tag">375px viewport</span>
      </div>
      <div class="section-body" style="display:flex;justify-content:center">
        <div class="mobile-demo">
          <div class="app-bar">Example Flow</div>
          <div class="mobile-body">
            <div class="h-stepper" id="mobile-stepper"></div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /tab-horizontal -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 2 â€“ VERTICAL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-pane" id="tab-vertical">

    <div class="section-card">
      <div class="section-header">
        <h2>Interactive Vertical Stepper</h2>
        <span class="variant-tag">5 Steps Â· Rebrand</span>
      </div>
      <div class="section-body">

        <div style="display:flex;gap:64px;flex-wrap:wrap;align-items:flex-start">

          <!-- Left: stepper -->
          <div style="flex:0 0 260px">
            <div class="v-stepper" id="v-stepper-track"></div>
          </div>

          <!-- Right: content panel -->
          <div style="flex:1;min-width:240px;padding-top:4px">
            <div style="font-size:11px;text-transform:uppercase;letter-spacing:.8px;color:var(--gray-400);font-weight:600;margin-bottom:12px">Active Step Content</div>
            <div id="v-content-panel">
              <!-- injected by JS -->
            </div>
          </div>

        </div>

        <div style="display:flex;align-items:center;gap:8px;margin-top:8px;min-height:20px">
          <span id="v-saving-chip" style="opacity:0;transition:opacity .3s;font-size:12px;color:var(--gray-600)">Savingâ€¦</span>
        </div>
        <div class="nav-row" style="margin-top:12px">
          <button class="btn btn-secondary" id="v-back">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Back
          </button>
          <button class="btn btn-primary" id="v-next">
            Next
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
        <!-- Inline validation / submission message -->
        <div id="v-inline-error" style="display:none;margin-top:12px;padding:10px 14px;background:#FFF3F3;border:1.5px solid #F44336;border-radius:8px;font-size:13px;color:#B71C1C"></div>

      </div>
    </div>

    <!-- 3-step variant -->
    <div class="section-card" style="margin-top:32px">
      <div class="section-header">
        <h2>3-Step Vertical Variant</h2>
        <span class="variant-tag">Static preview</span>
      </div>
      <div class="section-body">
        <div class="v-stepper" id="v-3-track"></div>
      </div>
    </div>

  </div><!-- /tab-vertical -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 3 â€“ CONDITIONAL LOGIC
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-pane" id="tab-conditional">

    <div class="section-card">
      <div class="section-header">
        <h2>Conditional Flow</h2>
        <span class="variant-tag">Internal branching Â· step-level conditions</span>
      </div>
      <div class="section-body">

        <p style="font-size:13px;color:var(--gray-600);margin-bottom:24px;line-height:1.6">Step 1 sets the top-level path. Within each path, certain steps contain <strong>internal conditions</strong> â€” a selection inside that step immediately spawns additional steps (shown in <span style="color:#4527A0;font-weight:600">purple</span>) into the flow before you advance.</p>

        <!-- Path tag -->
        <div class="path-tag hidden" id="cond-path-tag">
          <span class="path-dot"></span>
          <span id="cond-path-label">Path</span>
        </div>

        <!-- Branch changed banner -->
        <div class="branch-changed-banner hidden" id="cond-branch-banner">
          âš¡ Path updated â€” steps have changed based on your selection.
        </div>

        <!-- Spawn gate banner -->
        <div class="spawn-gate-banner hidden" id="cond-spawn-banner">
          <span style="font-size:16px">â‘‚</span>
          <span id="cond-spawn-banner-text">Your selection added steps to this flow.</span>
        </div>

        <!-- Conditional stepper track -->
        <div class="h-stepper" id="cond-stepper-track" style="margin-bottom:0"></div>

        <!-- Spawn pill (shown when sub-path is active) -->
        <div class="spawn-pill hidden" id="cond-spawn-pill" style="margin-top:10px">
          <span class="spawn-pill-dot"></span>
          <span id="cond-spawn-pill-text">Sub-path active</span>
        </div>

        <!-- Step content -->
        <div class="cond-step-content" id="cond-step-content"></div>

        <!-- Nav -->
        <div class="nav-row" style="margin-top:24px">
          <button class="btn btn-secondary" id="cond-back">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Back
          </button>
          <button class="btn btn-primary" id="cond-next" disabled>
            Next
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
        <div id="cond-inline-msg" style="display:none;margin-top:12px;padding:10px 14px;border-radius:8px;font-size:13px"></div>

      </div>
    </div>

    <!-- Live Branch Map (dynamically rendered) -->
    <div class="section-card" style="margin-top:32px">
      <div class="section-header">
        <h2>Live Branch Map</h2>
        <span class="variant-tag" id="cond-map-tag">Select a path to see internal branches</span>
      </div>
      <div class="section-body" style="padding:24px 32px">
        <div id="cond-branch-map">
          <p style="font-size:13px;color:var(--gray-400)">No path selected yet. Choose a request type in Step 1 to populate this map.</p>
        </div>
      </div>
    </div>

  </div><!-- /tab-conditional -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 3 â€“ ANATOMY & STATES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-pane" id="tab-states">

    <div class="section-card">
      <div class="section-header">
        <h2>Step Dot States</h2>
      </div>
      <div class="section-body">
        <div style="font-size:12px;text-transform:uppercase;letter-spacing:.8px;color:var(--gray-400);font-weight:600;margin-bottom:24px">Default variant (icon)</div>
        <div class="states-grid">
          <div class="state-demo">
            <div class="state-dot s-incomplete">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><circle cx="7" cy="7" r="5" stroke="#9E9E9E" stroke-width="1.5"/></svg>
            </div>
            <span class="state-label">Incomplete<br><span style="font-size:10px;color:#bbb">(not reachable via click)</span></span>
          </div>
          <div class="state-demo">
            <div class="state-dot" style="background:white;border:2px solid #0057FF">
              <svg viewBox="0 0 16 16" width="14" height="14"><line x1="3" y1="8" x2="13" y2="8" stroke="#0057FF" stroke-width="2.5" stroke-linecap="round"/></svg>
            </div>
            <span class="state-label">Partly complete<br><span style="font-size:10px;color:#bbb">(hover â†’ pencil)</span></span>
          </div>
          <div class="state-demo">
            <div class="state-dot s-current"></div>
            <span class="state-label">Current</span>
          </div>

        <div style="margin-top:40px">
          <div class="states-section-title">Numeral variant</div>
          <div class="states-grid">
            <div class="state-demo">
              <div class="state-dot s-incomplete">1</div>
              <span class="state-label">Incomplete</span>
            </div>
            <div class="state-demo">
              <div class="state-dot s-current-num">2</div>
              <span class="state-label">Current</span>
            </div>
            <div class="state-demo">
              <div class="state-dot s-complete">
                <svg class="check-icon" viewBox="0 0 16 16"><polyline points="3,8 6.5,11.5 13,5"/></svg>
              </div>
              <span class="state-label">Complete</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- connector states -->
    <div class="section-card" style="margin-top:32px">
      <div class="section-header">
        <h2>Connector Line States</h2>
      </div>
      <div class="section-body">
        <div class="states-grid">
          <div class="state-demo" style="flex-direction:row;align-items:center;gap:8px">
            <div style="width:80px;height:4px;background:var(--gray-200);border-radius:2px"></div>
            <span class="state-label">Incomplete</span>
          </div>
          <div class="state-demo" style="flex-direction:row;align-items:center;gap:8px">
            <div style="width:80px;height:4px;background:var(--blue-primary);border-radius:2px"></div>
            <span class="state-label">Complete</span>
          </div>
        </div>
      </div>
    </div>

    <!-- anatomy diagram -->
    <div class="section-card" style="margin-top:32px">
      <div class="section-header">
        <h2>Anatomy</h2>
      </div>
      <div class="section-body">
        <div id="anatomy-stepper" style="width:100%;max-width:640px"></div>
        <div style="margin-top:28px;display:flex;flex-direction:column;gap:10px;font-size:13px;color:var(--gray-600);">
          <div>â‘  <strong>Step dot</strong> â€“ Indicates step status (incomplete / current / complete)</div>
          <div>â‘¡ <strong>Connector line</strong> â€“ Visually links steps; color reflects progress</div>
          <div>â‘¢ <strong>Step label</strong> â€“ Text below dot; bold when current</div>
        </div>
      </div>
    </div>

    <!-- color specs -->
    <div class="section-card" style="margin-top:32px">
      <div class="section-header">
        <h2>Color Tokens</h2>
        <p style="margin:4px 0 0;font-size:13px;color:var(--gray-600)">Values verified against Figma Sequoia Library Â· <em>ğŸŒˆ Other/Core Blue</em> &amp; <em>global/text</em> tokens</p>
      </div>
      <div class="section-body">

        <!-- â”€â”€ Palette grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:32px">

          <!-- Core Blue -->
          <div style="border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)">
            <div style="height:80px;background:#0061F4;display:flex;align-items:center;justify-content:center">
              <span style="font-size:22px;color:white;font-weight:700;letter-spacing:.5px">#0061F4</span>
            </div>
            <div style="padding:10px 12px">
              <div style="font-size:12px;font-weight:600;color:#0061F4;margin-bottom:2px">ğŸŒˆ Other / Core Blue</div>
              <div style="font-size:12px;color:var(--gray-900);font-family:monospace;margin-bottom:4px">--blue-primary</div>
              <div style="font-size:11px;color:var(--gray-600)">Current &amp; complete dot Â· complete connector</div>
            </div>
          </div>

          <!-- Dark Brown / text_on_light -->
          <div style="border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)">
            <div style="height:80px;background:#281805;display:flex;align-items:center;justify-content:center">
              <span style="font-size:22px;color:white;font-weight:700;letter-spacing:.5px">#281805</span>
            </div>
            <div style="padding:10px 12px">
              <div style="font-size:12px;font-weight:600;color:#281805;margin-bottom:2px">global / text / text_on_light</div>
              <div style="font-size:12px;color:var(--gray-900);font-family:monospace;margin-bottom:4px">--gray-900</div>
              <div style="font-size:11px;color:var(--gray-600)">Current step label Â· primary text</div>
            </div>
          </div>

          <!-- White / text_on_dark -->
          <div style="border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)">
            <div style="height:80px;background:#ffffff;display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--gray-200)">
              <span style="font-size:22px;color:#281805;font-weight:700;letter-spacing:.5px">#FFFFFF</span>
            </div>
            <div style="padding:10px 12px">
              <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin-bottom:2px">global / text / text_on_dark</div>
              <div style="font-size:12px;color:var(--gray-900);font-family:monospace;margin-bottom:4px">--white</div>
              <div style="font-size:11px;color:var(--gray-600)">Numeral inside blue dot Â· surface</div>
            </div>
          </div>

          <!-- Neutral 150 / incomplete connector -->
          <div style="border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)">
            <div style="height:80px;background:#E0E0E0;display:flex;align-items:center;justify-content:center">
              <span style="font-size:22px;color:#281805;font-weight:700;letter-spacing:.5px">#E0E0E0</span>
            </div>
            <div style="padding:10px 12px">
              <div style="font-size:12px;font-weight:600;color:#6b6b6b;margin-bottom:2px">color / ğŸŒˆ-neutral / neutral-150</div>
              <div style="font-size:12px;color:var(--gray-900);font-family:monospace;margin-bottom:4px">--gray-200</div>
              <div style="font-size:11px;color:var(--gray-600)">Incomplete connector Â· incomplete dot border</div>
            </div>
          </div>

          <!-- Gray 400 / inactive label -->
          <div style="border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)">
            <div style="height:80px;background:#ABABAB;display:flex;align-items:center;justify-content:center">
              <span style="font-size:22px;color:white;font-weight:700;letter-spacing:.5px">#ABABAB</span>
            </div>
            <div style="padding:10px 12px">
              <div style="font-size:12px;font-weight:600;color:#6b6b6b;margin-bottom:2px">Sequoia / neutral-300</div>
              <div style="font-size:12px;color:var(--gray-900);font-family:monospace;margin-bottom:4px">--gray-400</div>
              <div style="font-size:11px;color:var(--gray-600)">Incomplete label Â· placeholder / inactive text</div>
            </div>
          </div>

          <!-- Gray 600 / complete label -->
          <div style="border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)">
            <div style="height:80px;background:#6B6B6B;display:flex;align-items:center;justify-content:center">
              <span style="font-size:22px;color:white;font-weight:700;letter-spacing:.5px">#6B6B6B</span>
            </div>
            <div style="padding:10px 12px">
              <div style="font-size:12px;font-weight:600;color:#6b6b6b;margin-bottom:2px">Sequoia / neutral-500</div>
              <div style="font-size:12px;color:var(--gray-900);font-family:monospace;margin-bottom:4px">--gray-600</div>
              <div style="font-size:11px;color:var(--gray-600)">Complete step label Â· secondary text</div>
            </div>
          </div>

          <!-- Gray 100 / surface -->
          <div style="border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)">
            <div style="height:80px;background:#F2F2F2;display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--gray-200)">
              <span style="font-size:22px;color:#281805;font-weight:700;letter-spacing:.5px">#F2F2F2</span>
            </div>
            <div style="padding:10px 12px">
              <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin-bottom:2px">Sequoia / neutral-50</div>
              <div style="font-size:12px;color:var(--gray-900);font-family:monospace;margin-bottom:4px">--gray-100</div>
              <div style="font-size:11px;color:var(--gray-600)">Page background Â· section surfaces</div>
            </div>
          </div>

        </div><!-- /palette grid -->

        <!-- â”€â”€ State color map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <h3 style="font-size:14px;font-weight:600;color:var(--gray-900);margin:0 0 12px">Color by Stepper State</h3>
        <div style="display:flex;flex-direction:column;gap:0;border:1px solid var(--gray-200);border-radius:10px;overflow:hidden;font-size:13px">

          <!-- header row -->
          <div style="display:grid;grid-template-columns:130px 1fr 1fr 1fr;background:var(--gray-100);padding:8px 14px;font-size:11px;font-weight:600;color:var(--gray-600);text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--gray-200)">
            <span>State</span><span>Dot</span><span>Connector</span><span>Label</span>
          </div>

          <!-- Current -->
          <div style="display:grid;grid-template-columns:130px 1fr 1fr 1fr;align-items:center;padding:10px 14px;border-bottom:1px solid var(--gray-200);gap:8px">
            <span style="font-weight:600;color:var(--gray-900)">Current</span>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:20px;height:20px;border-radius:50%;background:#0061F4;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                <span style="color:white;font-size:9px;font-weight:700">1</span>
              </div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">#0061F4</span>
            </div>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:28px;height:4px;background:#E0E0E0;border-radius:2px;flex-shrink:0"></div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">#E0E0E0</span>
            </div>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:12px;height:12px;border-radius:2px;background:#281805;flex-shrink:0"></div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">#281805 bold</span>
            </div>
          </div>

          <!-- Complete -->
          <div style="display:grid;grid-template-columns:130px 1fr 1fr 1fr;align-items:center;padding:10px 14px;border-bottom:1px solid var(--gray-200);gap:8px">
            <span style="font-weight:600;color:var(--gray-900)">Complete</span>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:20px;height:20px;border-radius:50%;background:#0061F4;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                <svg viewBox="0 0 16 16" style="width:11px;height:11px;stroke:white;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;fill:none"><polyline points="3,8 6.5,11.5 13,5"/></svg>
              </div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">#0061F4</span>
            </div>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:28px;height:4px;background:#0061F4;border-radius:2px;flex-shrink:0"></div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">#0061F4</span>
            </div>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:12px;height:12px;border-radius:2px;background:#6B6B6B;flex-shrink:0"></div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">#6B6B6B</span>
            </div>
          </div>

          <!-- Incomplete -->
          <div style="display:grid;grid-template-columns:130px 1fr 1fr 1fr;align-items:center;padding:10px 14px;border-bottom:1px solid var(--gray-200);gap:8px">
            <span style="font-weight:600;color:var(--gray-900)">Incomplete</span>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:20px;height:20px;border-radius:50%;background:white;border:2px solid #E0E0E0;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                <span style="color:#ABABAB;font-size:9px;font-weight:600">3</span>
              </div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">bg:#FFF Â· #E0E0E0</span>
            </div>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:28px;height:4px;background:#E0E0E0;border-radius:2px;flex-shrink:0"></div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">#E0E0E0</span>
            </div>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:12px;height:12px;border-radius:2px;background:#ABABAB;flex-shrink:0"></div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">#ABABAB</span>
            </div>
          </div>

          <!-- Partly Complete -->
          <div style="display:grid;grid-template-columns:130px 1fr 1fr 1fr;align-items:center;padding:10px 14px;gap:8px">
            <span style="font-weight:600;color:var(--gray-900)">Partly Complete</span>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:20px;height:20px;border-radius:50%;background:#0061F4;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                <svg viewBox="0 0 16 16" style="width:11px;height:11px"><line x1="3" y1="8" x2="13" y2="8" stroke="white" stroke-width="2.5" stroke-linecap="round"/></svg>
              </div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">#0061F4</span>
            </div>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:14px;height:4px;background:#0061F4;border-radius:2px 0 0 2px;flex-shrink:0"></div>
              <div style="width:14px;height:4px;background:#E0E0E0;border-radius:0 2px 2px 0;flex-shrink:0"></div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">split</span>
            </div>
            <div style="display:flex;align-items:center;gap:7px">
              <div style="width:12px;height:12px;border-radius:2px;background:#281805;flex-shrink:0"></div>
              <span style="font-family:monospace;font-size:11px;color:var(--gray-600)">#281805 bold</span>
            </div>
          </div>

        </div><!-- /state color map -->

        <!-- â”€â”€ CSS var reference â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <details style="margin-top:20px;border:1px solid var(--gray-200);border-radius:8px;overflow:hidden">
          <summary style="padding:10px 14px;font-size:13px;font-weight:600;color:var(--gray-900);cursor:pointer;background:var(--gray-100);list-style:none;display:flex;align-items:center;gap:6px">
            <span>â–¶</span> CSS Variable Definitions
          </summary>
          <pre style="margin:0;padding:14px;font-size:12px;line-height:1.7;color:var(--gray-600);background:white;overflow-x:auto">:root {
  /* Brand */
  --blue-primary: #0061f4;   /* ğŸŒˆ Other/Core Blue */

  /* Text */
  --gray-900:     #281805;   /* global/text/text_on_light */
  --gray-600:     #6b6b6b;
  --gray-400:     #ababab;
  --white:        #ffffff;   /* global/text/text_on_dark */

  /* Surfaces &amp; Connectors */
  --gray-200:     #e0e0e0;   /* color/ğŸŒˆ-neutral/neutral-150 */
  --gray-100:     #f2f2f2;

  /* Geometry */
  --dot-size:        32px;
  --dot-size-sm:     24px;
  --line-thickness:   4px;
}</pre>
        </details>

      </div>
    </div><!-- /Color Tokens -->

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         BLACK STYLE REFERENCE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section-card" style="margin-top:32px">
      <div class="section-header">
        <h2>Black Style Reference</h2>
        <p style="margin:4px 0 0;font-size:13px;color:var(--gray-600)">Figma token: <code>color / ğŸŒˆ-neutral / warm-black-850</code> &nbsp;Â·&nbsp; hex <strong>#281805</strong></p>
      </div>
      <div class="section-body">

        <!-- Side-by-side style comparison -->
        <h3 style="font-size:14px;font-weight:600;color:var(--gray-900);margin:0 0 14px">Rebrand vs Black â€” dot states at a glance</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px">

          <!-- Rebrand column -->
          <div style="border:1px solid var(--gray-200);border-radius:10px;overflow:hidden">
            <div style="padding:10px 14px;background:#EBF2FF;border-bottom:1px solid #C5D8FF;font-size:12px;font-weight:600;color:#0061F4">Rebrand style Â· Core Blue #0061F4</div>
            <div style="padding:16px 14px;display:flex;flex-direction:column;gap:14px">
              <!-- Current -->
              <div style="display:flex;align-items:center;gap:10px;font-size:13px">
                <div style="width:32px;height:32px;border-radius:50%;background:#0061F4;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <span style="color:white;font-size:13px;font-weight:700">2</span>
                </div>
                <div><strong>Current</strong> â€” solid blue, white numeral</div>
              </div>
              <!-- Complete -->
              <div style="display:flex;align-items:center;gap:10px;font-size:13px">
                <div style="width:32px;height:32px;border-radius:50%;background:#0061F4;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <svg viewBox="0 0 16 16" style="width:15px;height:15px;stroke:white;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;fill:none"><polyline points="3,8 6.5,11.5 13,5"/></svg>
                </div>
                <div><strong>Complete</strong> â€” solid blue, white âœ“</div>
              </div>
              <!-- Partly -->
              <div style="display:flex;align-items:center;gap:10px;font-size:13px">
                <div style="width:32px;height:32px;border-radius:50%;background:#0061F4;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <svg viewBox="0 0 16 16" style="width:14px;height:14px"><line x1="3" y1="8" x2="13" y2="8" stroke="white" stroke-width="2.5" stroke-linecap="round"/></svg>
                </div>
                <div><strong>Partly complete</strong> â€” solid blue, white dash</div>
              </div>
              <!-- Incomplete -->
              <div style="display:flex;align-items:center;gap:10px;font-size:13px">
                <div style="width:32px;height:32px;border-radius:50%;background:white;border:2px solid #E0E0E0;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <span style="color:#ABABAB;font-size:13px;font-weight:600">4</span>
                </div>
                <div><strong>Incomplete</strong> â€” outlined gray, gray numeral</div>
              </div>
              <!-- Connector -->
              <div style="display:flex;align-items:center;gap:10px;font-size:13px">
                <div style="display:flex;align-items:center;gap:0;flex-shrink:0">
                  <div style="width:20px;height:4px;background:#0061F4;border-radius:2px 0 0 2px"></div>
                  <div style="width:20px;height:4px;background:#E0E0E0;border-radius:0 2px 2px 0"></div>
                </div>
                <div><strong>Connector</strong> â€” blue (done) / gray (ahead)</div>
              </div>
            </div>
          </div>

          <!-- Black column -->
          <div style="border:1px solid var(--gray-200);border-radius:10px;overflow:hidden">
            <div style="padding:10px 14px;background:#f5f0eb;border-bottom:1px solid #c8b89a;font-size:12px;font-weight:600;color:#281805">Black style Â· warm-black-850 #281805</div>
            <div style="padding:16px 14px;display:flex;flex-direction:column;gap:14px">
              <!-- Current black -->
              <div style="display:flex;align-items:center;gap:10px;font-size:13px">
                <div style="width:32px;height:32px;border-radius:50%;background:white;border:2.5px solid #281805;display:flex;align-items:center;justify-content:center;flex-shrink:0;position:relative">
                  <div style="width:8px;height:8px;border-radius:50%;background:#281805"></div>
                </div>
                <div><strong>Current</strong> â€” outlined ring + center dot, no numeral</div>
              </div>
              <!-- Complete black -->
              <div style="display:flex;align-items:center;gap:10px;font-size:13px">
                <div style="width:32px;height:32px;border-radius:50%;background:#281805;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <svg viewBox="0 0 16 16" style="width:15px;height:15px;stroke:white;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;fill:none"><polyline points="3,8 6.5,11.5 13,5"/></svg>
                </div>
                <div><strong>Complete</strong> â€” solid dark, white âœ“</div>
              </div>
              <!-- Partly black -->
              <div style="display:flex;align-items:center;gap:10px;font-size:13px">
                <div style="width:32px;height:32px;border-radius:50%;background:#281805;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <svg viewBox="0 0 16 16" style="width:14px;height:14px"><line x1="3" y1="8" x2="13" y2="8" stroke="white" stroke-width="2.5" stroke-linecap="round"/></svg>
                </div>
                <div><strong>Partly complete</strong> â€” solid dark, white dash</div>
              </div>
              <!-- Incomplete black -->
              <div style="display:flex;align-items:center;gap:10px;font-size:13px">
                <div style="width:32px;height:32px;border-radius:50%;background:white;border:2px solid #E0E0E0;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  <span style="color:#ABABAB;font-size:13px;font-weight:600">4</span>
                </div>
                <div><strong>Incomplete</strong> â€” same as Rebrand (outlined gray)</div>
              </div>
              <!-- Connector black -->
              <div style="display:flex;align-items:center;gap:10px;font-size:13px">
                <div style="display:flex;align-items:center;gap:0;flex-shrink:0">
                  <div style="width:20px;height:4px;background:#281805;border-radius:2px 0 0 2px"></div>
                  <div style="width:20px;height:4px;background:#E0E0E0;border-radius:0 2px 2px 0"></div>
                </div>
                <div><strong>Connector</strong> â€” dark (done) / gray (ahead)</div>
              </div>
            </div>
          </div>
        </div><!-- /side-by-side -->

        <!-- Key diff callout -->
        <div style="background:#f5f0eb;border:1px solid #c8b89a;border-radius:8px;padding:14px 16px;font-size:13px;color:#281805">
          <strong>Key Figma token difference:</strong> The Black theme replaces <code style="background:rgba(0,0,0,.06);padding:1px 5px;border-radius:3px">--blue-primary (#0061F4)</code>
          with <code style="background:rgba(0,0,0,.06);padding:1px 5px;border-radius:3px">warm-black-850 (#281805)</code> for all active/complete dot fills and connector lines.
          The Current dot also switches from a <em>solid fill</em> to an <em>outlined ring + center dot</em> pattern.
          Label colors remain <code style="background:rgba(0,0,0,.06);padding:1px 5px;border-radius:3px">#281805</code> in both styles.
        </div>

      </div>
    </div><!-- /Black Style Reference -->

  </div><!-- /tab-states -->

</div><!-- /page-body -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SAVE & CONTINUE MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="save-modal">
  <div class="modal">
    <div class="modal-icon">âš ï¸</div>
    <h3>Save and continue?</h3>
    <p>Some required information on this step is missing. You can save your partial progress and return to complete it later, or stay and finish it now.</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="modal-cancel">Stay &amp; complete</button>
      <button class="btn btn-primary" id="modal-confirm">Save &amp; continue</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ JavaScript â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const svgCheck  = () => `<svg viewBox="0 0 16 16" style="width:15px;height:15px;stroke:white;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;fill:none"><polyline points="3,8 6.5,11.5 13,5"/></svg>`;
const svgDot    = () => ``; // center dot rendered via CSS ::after on .current
const svgDash   = (color = '#0057FF') => `<svg viewBox="0 0 16 16" style="width:14px;height:14px"><line x1="3" y1="8" x2="13" y2="8" stroke="${color}" stroke-width="2.5" stroke-linecap="round"/></svg>`;
const svgPencil = (color = 'white') => `<svg viewBox="0 0 16 16" style="width:14px;height:14px;fill:none;stroke:${color};stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round"><path d="M11.5 2.5a1.414 1.414 0 0 1 2 2L5 13H3v-2L11.5 2.5z"/></svg>`;

const STEP_NAMES = ['Account', 'Identity', 'Coverage', 'Payment', 'Review', 'Confirm', 'Submit', 'Done'];
const V_STEPS = [
  { label:'Account Setup',   desc:'Enter your account credentials and contact information.' },
  { label:'Identity Verify', desc:'Confirm your identity using your policy number or SSN.' },
  { label:'Coverage Details',desc:'Select or review the coverage plan for your policy.' },
  { label:'Payment Method',  desc:'Add a bank account or credit card for recurring payments.' },
  { label:'Review & Submit', desc:'Review all your information before final submission.' },
];
const V_3_STEPS = [
  { label:'Account',  desc:'Enter your credentials.',        partly: false },
  { label:'Coverage', desc:'Select your coverage plan.',     partly: true  },
  { label:'Confirm',  desc:'Review and confirm your details.', partly: false },
];

/* â”€â”€ Step Form Definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const STEP_FORMS = [
  { title: 'Account Setup', fields: [
    { id:'full-name',  label:'Full name',      required:true,  type:'text',  placeholder:'Jane Doe' },
    { id:'email',      label:'Email address',  required:true,  type:'email', placeholder:'jane@example.com' },
    { id:'phone',      label:'Phone number',   required:false, type:'tel',   placeholder:'555-0100', hint:'Optional' },
  ]},
  { title: 'Identity Verify', fields: [
    { id:'policy-num', label:'Policy number',          required:true, type:'text', placeholder:'POL-000000' },
    { id:'ssn-last4',  label:'Last 4 digits of SSN',   required:true, type:'text', placeholder:'0000', maxlength:'4' },
  ]},
  { title: 'Coverage Details', fields: [
    { id:'plan',       label:'Coverage plan',     required:true,  type:'select', options:['Select a planâ€¦','Basic â€” $150/mo','Standard â€” $250/mo','Premium â€” $400/mo'] },
    { id:'deductible', label:'Deductible amount', required:false, type:'select', options:['No preference','$500','$1,000','$2,500'], hint:'Optional' },
  ]},
  { title: 'Payment Method', fields: [
    { id:'pay-type',   label:'Payment method',        required:true,  type:'select', options:['Selectâ€¦','Bank account (ACH)','Credit card','Debit card'] },
    { id:'acct-name',  label:'Account holder name',   required:true,  type:'text',   placeholder:'Jane Doe' },
    { id:'acct-num',   label:'Account / card number', required:false, type:'text',   placeholder:'â€¢â€¢â€¢â€¢ 0000', hint:'Optional â€” for demo only' },
  ]},
  { title: 'Review & Submit', fields: [
    { id:'confirm-info',  label:'All information provided is accurate',  required:true, type:'checkbox' },
    { id:'agree-terms',   label:'I agree to the terms and conditions',   required:true, type:'checkbox' },
  ]},
];

/* â”€â”€ Step field data store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let stepData = {}; // { [stepIndex]: { [fieldId]: value } }

function getStepForm(stepIndex) {
  return STEP_FORMS[stepIndex % STEP_FORMS.length];
}

function isStepComplete(stepIndex) {
  const form = getStepForm(stepIndex);
  if (!form) return true;
  const data = stepData[stepIndex] || {};
  return form.fields.filter(f => f.required).every(f => {
    const v = data[f.id];
    if (f.type === 'checkbox') return v === 'true' || v === true;
    return v && String(v).trim() !== '';
  });
}

function hasPartialData(stepIndex) {
  const form = getStepForm(stepIndex);
  if (!form) return false;
  const data = stepData[stepIndex] || {};
  const anyFilled = form.fields.some(f => {
    const v = data[f.id];
    if (f.type === 'checkbox') return v === 'true' || v === true;
    return v && String(v).trim() !== '';
  });
  return anyFilled && !isStepComplete(stepIndex);
}

function renderStepForm(stepIndex, titleEl, bodyEl) {
  const form = getStepForm(stepIndex);
  if (!form) { bodyEl.innerHTML = '<div class="step-form-empty">No form for this step.</div>'; return; }
  if (titleEl) titleEl.textContent = form.title;
  const data = stepData[stepIndex] || {};
  const wrap = document.createElement('div');
  wrap.className = 'step-form';
  form.fields.forEach(f => {
    const group = document.createElement('div');
    group.className = 'field-group';
    const req = f.required ? '<span class="req-mark">*</span>' : '';
    const stored = data[f.id] ?? '';
    if (f.type === 'checkbox') {
      const checked = stored === 'true' || stored === true;
      group.innerHTML = `<label class="check-row"><input type="checkbox" data-field="${f.id}" data-step="${stepIndex}" ${checked ? 'checked' : ''}><span>${f.label}${req}</span></label>`;
    } else if (f.type === 'select') {
      const opts = f.options.map((o, i) => `<option value="${i === 0 ? '' : o}" ${stored === o ? 'selected' : ''}>${o}</option>`).join('');
      group.innerHTML = `<span class="field-label">${f.label}${req}</span><select data-field="${f.id}" data-step="${stepIndex}">${opts}</select>${f.hint ? `<span class="field-hint">${f.hint}</span>` : ''}`;
    } else {
      group.innerHTML = `<span class="field-label">${f.label}${req}</span><input type="${f.type}" data-field="${f.id}" data-step="${stepIndex}" placeholder="${f.placeholder || ''}" value="${stored}" ${f.maxlength ? `maxlength="${f.maxlength}"` : ''}>${f.hint ? `<span class="field-hint">${f.hint}</span>` : ''}`;
    }
    wrap.appendChild(group);
  });
  bodyEl.innerHTML = '';
  bodyEl.appendChild(wrap);
  // Wire change/input events
  wrap.querySelectorAll('input, select').forEach(el => {
    const save = (e) => {
      const si = parseInt(e.target.dataset.step);
      const fi = e.target.dataset.field;
      if (!stepData[si]) stepData[si] = {};
      stepData[si][fi] = e.target.type === 'checkbox' ? String(e.target.checked) : e.target.value;
      // Clear error highlight once user fills it
      e.target.classList.remove('field-error');
      const errMsg = e.target.parentElement.querySelector('.field-error-msg');
      if (errMsg) errMsg.remove();
      saveState();
    };
    el.addEventListener('change', save);
    if (el.type !== 'checkbox' && el.tagName !== 'SELECT') el.addEventListener('input', save);
  });
}

function highlightMissingFields(stepIndex) {
  const form = getStepForm(stepIndex);
  if (!form) return;
  const data = stepData[stepIndex] || {};
  form.fields.filter(f => f.required).forEach(f => {
    const v = data[f.id];
    const isEmpty = f.type === 'checkbox'
      ? !(v === 'true' || v === true)
      : !v || String(v).trim() === '';
    if (!isEmpty) return;
    // Find the input/select with matching data-field
    ['h-step-form-body','v-step-form-body'].forEach(bodyId => {
      const body = document.getElementById(bodyId);
      if (!body) return;
      const el = body.querySelector(`[data-field="${f.id}"]`);
      if (!el) return;
      el.classList.add('field-error');
      if (!el.parentElement.querySelector('.field-error-msg')) {
        const msg = document.createElement('span');
        msg.className = 'field-error-msg';
        msg.textContent = 'This field is required';
        el.parentElement.appendChild(msg);
      }
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HORIZONTAL STEPPER ENGINE

   Interaction rules:
   â€¢ Future (incomplete) steps: not hoverable, not clickable.
   â€¢ Complete + partly-complete steps: hoverable (pencil icon +
     underlined label), clickable (jump back).
   â€¢ Advance only via Continue button.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let hTotal          = 5;
let hCurrent        = 2;              // start at step 3 to show all states
let hPartlyComplete = new Set([1]);   // step 2 (index 1) pre-set as partly complete
let hCompleted      = new Set([0]);   // step 1 (index 0) pre-completed at init

function dotHtml(state, num, smallDot) {
  const sz  = smallDot ? 11 : 14;
  const pen = svgPencil('white');
  let normal;
  if (state === 'complete')             normal = svgCheck();
  else if (state === 'partly-complete') normal = svgDash('white');
  else                                  normal = `<span style="font-size:${sz}px">${num}</span>`;
  return `<span class="dot-normal">${normal}</span><span class="dot-pencil">${pen}</span>`;
}

function buildHStepper(container, total, current, smallDot = false, partlySet = new Set(), interactive = false, completedSet = null) {
  container.innerHTML = '';
  const dotPx = smallDot ? 24 : 32;

  for (let i = 0; i < total; i++) {
    const isComplete       = completedSet
      ? completedSet.has(i) && i !== current
      : i < current && !partlySet.has(i);
    const isPartlyComplete = completedSet
      ? partlySet.has(i) && i !== current
      : i < current && partlySet.has(i);
    const isCurrent        = i === current;
    const isFuture         = !isComplete && !isPartlyComplete && !isCurrent;

    // Connector
    if (i > 0) {
      const line = document.createElement('div');
      // line is blue if the step to its left has been completed or partly-completed
      const prevDone = completedSet
        ? (completedSet.has(i - 1) || partlySet.has(i - 1))
        : i <= current;
      line.className = 'h-connector' + (prevDone ? ' complete' : '');
      container.appendChild(line);
    }

    const step = document.createElement('div');
    let cls = 'h-step';
    if (isCurrent)        cls += ' is-current';
    if (isComplete)       cls += ' is-complete is-hoverable';
    if (isPartlyComplete) cls += ' is-partly-complete is-hoverable';
    if (isFuture)         cls += ' is-future';
    step.className = cls;
    if (isCurrent) {
      step.setAttribute('aria-current', 'step');
    }
    if (isFuture) {
      step.setAttribute('aria-disabled', 'true');
      step.setAttribute('tabindex', '-1');
    }

    const dotState = isComplete ? 'complete' : isPartlyComplete ? 'partly-complete' : isCurrent ? 'current' : 'incomplete';
    const name     = STEP_NAMES[i] || `Step ${i + 1}`;
    const lWeight  = isCurrent ? '700' : (isComplete || isPartlyComplete) ? '400' : '400';
    const lColor   = isCurrent ? 'var(--gray-900)'
                   : isComplete || isPartlyComplete ? 'var(--gray-600)'
                   : 'var(--gray-400)';
    const tip      = isComplete ? 'Completed step' : isPartlyComplete ? 'Partly completed step' : isCurrent ? 'Current step' : '';

    step.innerHTML = `
      <div class="h-step-inner">
        <div class="h-dot ${dotState}" style="width:${dotPx}px;height:${dotPx}px"${tip ? ` data-tip="${tip}"` : ''}>
          ${dotHtml(dotState, i + 1, smallDot)}
        </div>
        <span class="h-label" style="font-weight:${lWeight};color:${lColor}">${name}</span>
      </div>
    `;

    // Only complete / partly-complete steps are clickable
    if (interactive && (isComplete || isPartlyComplete)) {
      step.addEventListener('click', () => { hCurrent = i; renderHStepper(); });
    }

    container.appendChild(step);
  }
}

const NEXT_SVG   = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
const SUBMIT_SVG = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><polyline points="4,10 8.5,14.5 16,6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

function renderHStepper() {
  const container = document.getElementById('h-stepper-track');
  buildHStepper(container, hTotal, hCurrent, false, hPartlyComplete, true, hCompleted);

  const isPartly = hPartlyComplete.has(hCurrent);
  const isLast   = hCurrent === hTotal - 1;
  document.getElementById('h-progress-chip').textContent = `Step ${hCurrent + 1} of ${hTotal}`;
  document.getElementById('h-back').disabled = hCurrent === 0;
  const hNextBtn = document.getElementById('h-next');
  hNextBtn.disabled = false;
  hNextBtn.innerHTML = isLast ? `Submit ${SUBMIT_SVG}` : `Next ${NEXT_SVG}`;
  document.getElementById('h-count-display').textContent = hTotal;

  // Render step form
  const formIndex = hCurrent % STEP_FORMS.length;
  renderStepForm(formIndex,
    document.getElementById('h-step-form-title'),
    document.getElementById('h-step-form-body')
  );
  saveState();
}

/* â”€â”€ Next (Forward Navigation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Linear only. Validate on click:
   - Last step â†’ handleSubmit()
   - Has partial data â†’ show modal
   - No data entered  â†’ show inline validation error
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('h-next').addEventListener('click', () => {
  hideInlineError('h');
  const formIdx = hCurrent % STEP_FORMS.length;
  if (hCurrent === hTotal - 1) { handleSubmit('h'); return; }
  if (isStepComplete(formIdx)) {
    hCompleted.add(hCurrent);
    hPartlyComplete.delete(hCurrent);
    hCurrent++;
    renderHStepper();
  } else if (hasPartialData(formIdx)) {
    showModal('h');
  } else {
    showInlineError('h', 'Please complete the required fields (*) on this step before continuing.');
  }
});
document.getElementById('v-next').addEventListener('click', () => {
  hideInlineError('v');
  const formIdx = vCurrent % STEP_FORMS.length;
  if (vCurrent === V_STEPS.length - 1) { handleSubmit('v'); return; }
  if (isStepComplete(formIdx)) {
    vCompleted.add(vCurrent);
    vPartlyComplete.delete(vCurrent);
    vCurrent++;
    renderVStepper();
  } else if (hasPartialData(formIdx)) {
    showModal('v');
  } else {
    showInlineError('v', 'Please complete the required fields (*) on this step before continuing.');
  }
});

/* â”€â”€ Back (Backward Navigation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Always allowed, never blocked.
   Auto-saves current step if partly complete.
   No modal shown.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('h-back').addEventListener('click', () => {
  if (hCurrent === 0) return;
  hideInlineError('h');
  const leavingPartly = hPartlyComplete.has(hCurrent);
  hCurrent--;
  if (leavingPartly) showSavingIndicator('h', () => renderHStepper());
  else renderHStepper();
});

/* v-next was wired through modal above; v-back here */
document.getElementById('v-back').addEventListener('click', () => {
  if (vCurrent === 0) return;
  hideInlineError('v');
  const leavingPartly = vPartlyComplete.has(vCurrent);
  vCurrent--;
  if (leavingPartly) showSavingIndicator('v', () => renderVStepper());
  else renderVStepper();
});

/* Step count +/- */
document.getElementById('h-inc').addEventListener('click', () => {
  if (hTotal < 8) { hTotal++; renderHStepper(); }
});
document.getElementById('h-dec').addEventListener('click', () => {
  if (hTotal > 2) {
    hTotal--;
    if (hCurrent >= hTotal) hCurrent = hTotal - 1;
    renderHStepper();
  }
});

/* Static variants (non-interactive, show partly-complete) */
function buildVariants() {
  const wrap = document.getElementById('h-variants-wrap');
  const configs = [
    { count: 3, current: 1, partly: new Set(),  label: '3 Steps Â· Step 2 current' },
    { count: 5, current: 3, partly: new Set([1]), label: '5 Steps Â· Step 2 partly complete Â· Step 4 current' },
    { count: 8, current: 4, partly: new Set([2]), label: '8 Steps Â· Step 3 partly complete Â· Step 5 current' },
  ];
  configs.forEach(({ count, current, partly, label }) => {
    const block = document.createElement('div');
    block.className = 'demo-block';
    block.innerHTML = `<div class="demo-label">${label}</div>`;
    const track = document.createElement('div');
    track.className = 'h-stepper';
    buildHStepper(track, count, current, false, partly, false);
    block.appendChild(track);
    wrap.appendChild(block);
  });
}

/* Mobile 3-step (step 2 active, step 1 complete) */
function buildMobileStepper() {
  const track = document.getElementById('mobile-stepper');
  buildHStepper(track, 3, 1, true, new Set(), false);
}

/* Anatomy view */
function buildAnatomyStepper() {
  const el = document.getElementById('anatomy-stepper');
  el.innerHTML = '';
  el.className = 'h-stepper';
  buildHStepper(el, 4, 2, false, new Set([1]), false);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VERTICAL STEPPER ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let vCurrent        = 2;
let vPartlyComplete = new Set([1]);
let vCompleted      = new Set([0]);

function dotHtmlV(state, num) {
  const pen = svgPencil('white');
  let normal;
  if (state === 'complete')             normal = svgCheck();
  else if (state === 'partly-complete') normal = svgDash('white');
  else                                  normal = `<span>${num}</span>`;
  return `<span class="dot-normal">${normal}</span><span class="dot-pencil">${pen}</span>`;
}

function buildVStepper(container, steps, current, interactive = false, partlySet = new Set(), completedSet = null) {
  container.innerHTML = '';
  steps.forEach((s, i) => {
    const isComplete       = completedSet
      ? completedSet.has(i) && i !== current
      : i < current && !partlySet.has(i);
    const isPartlyComplete = completedSet
      ? partlySet.has(i) && i !== current
      : i < current && partlySet.has(i);
    const isCurrent        = i === current;
    const isFuture         = !isComplete && !isPartlyComplete && !isCurrent;

    const dotState = isComplete ? 'complete' : isPartlyComplete ? 'partly-complete' : isCurrent ? 'current' : 'incomplete';
    const tip      = isComplete ? 'Completed step' : isPartlyComplete ? 'Partly completed step' : isCurrent ? 'Current step' : '';

    const stepEl = document.createElement('div');
    let cls = 'v-step';
    if (isCurrent)        cls += ' is-current';
    if (isComplete)       cls += ' is-complete is-hoverable';
    if (isPartlyComplete) cls += ' is-partly-complete is-hoverable';
    if (isFuture)         cls += ' is-future';
    stepEl.className = cls;
    if (isCurrent) stepEl.setAttribute('aria-current', 'step');
    if (isFuture)  { stepEl.setAttribute('aria-disabled', 'true'); stepEl.setAttribute('tabindex', '-1'); }

    const lineHtml = i < steps.length - 1
      ? `<div class="v-line${(isComplete || isPartlyComplete) ? ' complete' : ''}"></div>`
      : '';

    stepEl.innerHTML = `
      <div class="v-step-aside">
        <div class="v-dot ${dotState}"${tip ? ` data-tip="${tip}"` : ''}>${dotHtmlV(dotState, i + 1)}</div>
        ${lineHtml}
      </div>
      <div class="v-step-body">
        <div class="v-step-title">${s.label}</div>
        <div class="v-step-desc">${s.desc}</div>
      </div>
    `;

    if (interactive && (isComplete || isPartlyComplete)) {
      stepEl.addEventListener('click', () => {
        if (i >= vCurrent) return; // backward only
        const leavingPartly = vPartlyComplete.has(vCurrent);
        vCurrent = i;
        if (leavingPartly) showSavingIndicator('v', () => renderVStepper());
        else renderVStepper();
      });
    }
    container.appendChild(stepEl);
  });
}

function renderVStepper() {
  buildVStepper(document.getElementById('v-stepper-track'), V_STEPS, vCurrent, true, vPartlyComplete, vCompleted);
  const isPartly = vPartlyComplete.has(vCurrent);
  const isLast   = vCurrent === V_STEPS.length - 1;

  // Content panel: step header + form
  const panel = document.getElementById('v-content-panel');
  panel.innerHTML = `
    <div style="font-size:18px;font-weight:700;color:var(--gray-900);margin-bottom:4px">${V_STEPS[vCurrent].label}</div>
    <div style="font-size:14px;color:var(--gray-600);line-height:1.6;margin-bottom:16px;margin-top:6px">${V_STEPS[vCurrent].desc}</div>
    <div id="v-step-form-body"></div>
  `;
  renderStepForm(vCurrent, null, document.getElementById('v-step-form-body'));

  document.getElementById('v-back').disabled = vCurrent === 0;
  const vNextBtn = document.getElementById('v-next');
  vNextBtn.disabled = false;
  vNextBtn.innerHTML = isLast ? `Submit ${SUBMIT_SVG}` : `Next ${NEXT_SVG}`;
  saveState();
}

// v-next wired through modal above

/* 3-step static â€” step 2 is partly complete */
function buildV3() {
  buildVStepper(document.getElementById('v-3-track'), V_3_STEPS, 2, false, new Set([1]));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL LOGIC: comment update
   - "Save & continue" â†’ step becomes Partly completed, advance
   - "Stay & complete" â†’ close modal, show inline errors, stay
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let pendingModalStepper = null; // 'h' or 'v'

function showModal(which) {
  pendingModalStepper = which;
  document.getElementById('save-modal').classList.add('visible');
}
function hideModal() {
  document.getElementById('save-modal').classList.remove('visible');
  pendingModalStepper = null;
}

// "Save & continue" â€” marks current step as partly complete
document.getElementById('modal-confirm').addEventListener('click', () => {
  if (pendingModalStepper === 'h') {
    hPartlyComplete.add(hCurrent);
    hCurrent++;
    renderHStepper();
  } else if (pendingModalStepper === 'v') {
    vPartlyComplete.add(vCurrent);
    vCurrent++;
    renderVStepper();
  }
  hideModal();
});

// "Stay & complete" â€” close modal, show inline errors, user stays on current step
document.getElementById('modal-cancel').addEventListener('click', () => {
  const which = pendingModalStepper;
  hideModal();
  showInlineError(which, 'Please complete all required fields before moving on.');
});

// Close on overlay click
document.getElementById('save-modal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) hideModal();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB SWITCHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME TOGGLE  (Rebrand â†” Black)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.theme-toggle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.theme-toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const isBlack = btn.dataset.theme === 'black';
    document.body.classList.toggle('theme-black', isBlack);
    /* Update variant-tag labels */
    document.querySelectorAll('.theme-variant-tag').forEach(el => {
      el.textContent = isBlack ? 'Black Â· warm-black-850' : 'Rebrand Â· Core Blue';
    });
    /* Re-render all steppers so dot colors update */
    renderHStepper();
    buildVariants();
    renderVStepper();
    buildV3();
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* localStorage persistence */
const STORE_KEY = 'sequoia-stepper-state';
function saveState() {
  try {
    localStorage.setItem(STORE_KEY, JSON.stringify({
      hCurrent, hTotal,
      hPartlyComplete: [...hPartlyComplete],
      hCompleted: [...hCompleted],
      vCurrent,
      vPartlyComplete: [...vPartlyComplete],
      vCompleted: [...vCompleted],
      stepData,
    }));
  } catch {}
}
function restoreState() {
  try {
    const s = JSON.parse(localStorage.getItem(STORE_KEY));
    if (!s) return;
    hTotal          = s.hTotal          ?? hTotal;
    hCurrent        = s.hCurrent        ?? hCurrent;
    hPartlyComplete = new Set(s.hPartlyComplete ?? []);
    // Derive hCompleted from cursor position if not in saved state (old format)
    hCompleted      = new Set(s.hCompleted ??
      [...Array(hCurrent).keys()].filter(i => !hPartlyComplete.has(i)));
    vCurrent        = s.vCurrent        ?? vCurrent;
    vPartlyComplete = new Set(s.vPartlyComplete ?? []);
    vCompleted      = new Set(s.vCompleted ??
      [...Array(vCurrent).keys()].filter(i => !vPartlyComplete.has(i)));
    stepData        = s.stepData        ?? {};
  } catch {}
}

/* Simulate partial data: reads actual field state */
// hasPartialData(stepIndex) is now defined above in STEP_FORMS section

/* Saving indicator â€” shown when leaving a partly-complete step via backward nav */
function showSavingIndicator(which, callback) {
  const el = document.getElementById(which === 'h' ? 'h-saving-chip' : 'v-saving-chip');
  if (el) {
    el.style.opacity = '1';
    setTimeout(() => {
      el.style.opacity = '0';
      if (callback) callback();
    }, 900);
  } else {
    if (callback) callback();
  }
}

/* Inline error / validation messages (in-page only, not on stepper) */
function showInlineError(which, msg) {
  const el = document.getElementById(which === 'h' ? 'h-inline-error' : 'v-inline-error');
  if (!el) return;
  el.style.background = '#FFF3F3';
  el.style.border = '1.5px solid #F44336';
  el.style.color = '#B71C1C';
  el.innerHTML = msg;
  el.style.display = 'block';
}
function hideInlineError(which) {
  const el = document.getElementById(which === 'h' ? 'h-inline-error' : 'v-inline-error');
  if (el) el.style.display = 'none';
}

/* Final submission eligibility check (Â§9.1)
   Blocks if any prior step is Incomplete OR Partly completed.
   Prioritizes Incomplete over Partly completed for the CTA target (Â§9.2B). */
function handleSubmit(which) {
  const completedSet = which === 'h' ? hCompleted : vCompleted;
  const partlySet    = which === 'h' ? hPartlyComplete : vPartlyComplete;
  const total        = which === 'h' ? hTotal : V_STEPS.length;
  const el           = document.getElementById(which === 'h' ? 'h-inline-error' : 'v-inline-error');

  // Collect all prior steps (0..total-2) that are not Completed
  const unfinished = [];
  for (let i = 0; i < total - 1; i++) {
    if (!completedSet.has(i)) unfinished.push(i);
  }

  if (unfinished.length > 0) {
    // Prioritize true-Incomplete (never started) over Partly completed for CTA
    const firstIncomplete = unfinished.find(i => !partlySet.has(i));
    const ctaStep = firstIncomplete !== undefined ? firstIncomplete : unfinished[0];
    const incCount   = unfinished.filter(i => !partlySet.has(i)).length;
    const partCount  = unfinished.filter(i =>  partlySet.has(i)).length;
    let detail = '';
    if (incCount > 0 && partCount > 0)
      detail = ` (${incCount} not started, ${partCount} partly completed)`;
    else if (partCount > 0)
      detail = partCount === 1 ? ' (partly completed)' : ` (${partCount} partly completed)`;
    else
      detail = incCount === 1 ? ' (not yet started)' : ` (${incCount} not yet started)`;
    if (el) {
      el.style.background = '#FFF3F3';
      el.style.border = '1.5px solid #F44336';
      el.style.color = '#B71C1C';
      el.innerHTML =
        `<strong>Submission blocked.</strong> You have ${unfinished.length} unfinished step${unfinished.length > 1 ? 's' : ''}${detail}. ` +
        `<a href="#" class="go-to-incomplete" data-which="${which}" data-step="${ctaStep}" ` +
        `style="color:#0057FF;text-decoration:underline;cursor:pointer">Go to first unfinished step â†’</a>`;
      el.style.display = 'block';
    }
    return;
  }

  // All prior steps Completed â€” success
  if (el) {
    el.style.background = '#E8F5E9';
    el.style.border = '1.5px solid #4CAF50';
    el.style.color = '#1B5E20';
    el.innerHTML = 'âœ… <strong>Submitted successfully!</strong> All steps are complete.';
    el.style.display = 'block';
  }
}

/* CTA: Go to first incomplete step */
document.addEventListener('click', (e) => {
  const a = e.target.closest('.go-to-incomplete');
  if (!a) return;
  e.preventDefault();
  const which = a.dataset.which;
  const step  = parseInt(a.dataset.step);
  hideInlineError(which);
  if (which === 'h') { hCurrent = step; renderHStepper(); }
  else               { vCurrent = step; renderVStepper(); }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
restoreState();
renderHStepper();
buildVariants();
buildMobileStepper();
renderVStepper();
buildV3();
buildAnatomyStepper();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONDITIONAL STEPPER ENGINE  (internal branching edition)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const COND_PATHS = {
  new_policy: {
    label: 'New Policy Application',
    icon: 'ğŸ“‹',
    baseSteps: ['Request Type', 'Eligibility', 'Coverage', 'Payment'],
    baseContent: [
      null, // step 0 = choice UI
      { title: 'Eligibility Check', fields: [
        { label: 'Date of birth', type: 'input', placeholder: 'MM/DD/YYYY' },
        { label: 'Tobacco use in last 12 months?', type: 'select', options: ['Selectâ€¦', 'No', 'Yes'] },
        { label: 'State of residence', type: 'branch-select', branchKey: 'state_branch',
          options: ['Select stateâ€¦', 'California', 'Texas', 'New York', 'Florida', 'Other'],
          hint: 'CA or NY selections add a state-specific compliance step.' },
      ]},
      { title: 'Coverage Selection', fields: [
        { label: 'Coverage type', type: 'branch-select', branchKey: 'coverage_branch',
          options: ['Selectâ€¦', 'Term Life â€” 10yr', 'Term Life â€” 20yr', 'Whole Life', 'Universal Life'],
          hint: 'Permanent life products add investment / risk profile steps.' },
        { label: 'Coverage amount', type: 'select', options: ['Selectâ€¦', '$250,000', '$500,000', '$1,000,000', '$2,000,000'] },
      ]},
      { title: 'Payment Setup', fields: [
        { label: 'Payment method', type: 'select', options: ['Selectâ€¦', 'Bank account (ACH)', 'Credit card', 'Debit card'] },
        { label: 'Billing frequency', type: 'select', options: ['Selectâ€¦', 'Monthly', 'Quarterly', 'Annually'] },
      ]},
    ],
    branches: {
      state_branch: {
        afterBaseIndex: 1, triggerLabel: 'State of residence',
        map: {
          'California': { steps: ['CA Compliance'], content: [
            { title: 'California Compliance', fields: [
              { label: 'CA insurance disclosure acknowledged', type: 'checkbox' },
              { label: 'Replacement policy?', type: 'select', options: ['Selectâ€¦', 'No', 'Yes'] },
            ]},
          ]},
          'New York': { steps: ['NY Suitability'], content: [
            { title: 'New York Suitability Review', fields: [
              { label: 'Annual household income', type: 'select', options: ['Selectâ€¦', 'Under $50k', '$50kâ€“$100k', '$100kâ€“$250k', 'Over $250k'] },
              { label: 'NY suitability form acknowledged', type: 'checkbox' },
            ]},
          ]},
        },
      },
      coverage_branch: {
        afterBaseIndex: 2, triggerLabel: 'Coverage type',
        map: {
          'Whole Life': { steps: ['Investment Preferences'], content: [
            { title: 'Investment Preferences', fields: [
              { label: 'Preferred dividend option', type: 'select', options: ['Selectâ€¦', 'Paid-up additions', 'Cash', 'Reduce premium', 'Accumulate at interest'] },
              { label: 'Loan interest option', type: 'select', options: ['Selectâ€¦', 'Fixed', 'Variable'] },
            ]},
          ]},
          'Universal Life': { steps: ['Investment Preferences', 'Risk Profile'], content: [
            { title: 'Investment Preferences', fields: [
              { label: 'Index strategy', type: 'select', options: ['Selectâ€¦', 'Fixed account', 'S&P 500 indexed', 'Global multi-index'] },
              { label: 'Premium allocation', type: 'select', options: ['Selectâ€¦', '100% indexed', '50/50 split', 'Custom'] },
            ]},
            { title: 'Risk Profile', fields: [
              { label: 'Investment experience', type: 'select', options: ['Selectâ€¦', 'None', 'Limited', 'Moderate', 'Extensive'] },
              { label: 'Risk tolerance', type: 'select', options: ['Selectâ€¦', 'Conservative', 'Moderate', 'Aggressive'] },
            ]},
          ]},
        },
      },
    },
  },

  update_beneficiary: {
    label: 'Update Beneficiary',
    icon: 'ğŸ‘¤',
    baseSteps: ['Request Type', 'Verify Identity', 'Beneficiary Details', 'Confirm'],
    baseContent: [
      null,
      { title: 'Verify Your Identity', fields: [
        { label: 'Policy number', type: 'input', placeholder: 'POL-000000' },
        { label: 'Last 4 digits of SSN', type: 'input', placeholder: '0000' },
        { label: 'Policy ownership', type: 'branch-select', branchKey: 'ownership_branch',
          options: ['Selectâ€¦', 'Individual', 'Joint policy', 'Trust-owned'],
          hint: 'Non-individual ownership adds verification steps.' },
      ]},
      { title: 'Beneficiary Details', fields: [
        { label: 'Full name', type: 'input', placeholder: 'Full legal name' },
        { label: 'Relationship', type: 'select', options: ['Selectâ€¦', 'Spouse', 'Child', 'Parent', 'Sibling', 'Other'] },
        { label: 'Beneficiary is a minor?', type: 'branch-select', branchKey: 'minor_branch',
          options: ['Selectâ€¦', 'No', 'Yes â€” under 18'],
          hint: 'Minor designations require a guardian or trustee step.' },
        { label: 'Percentage of benefit', type: 'select', options: ['Selectâ€¦', '100%', '75%', '50%', '25%'] },
      ]},
      { title: 'Review & Confirm', fields: [
        { label: 'Confirm all beneficiary information is accurate', type: 'checkbox' },
      ]},
    ],
    branches: {
      ownership_branch: {
        afterBaseIndex: 1, triggerLabel: 'Policy ownership',
        map: {
          'Joint policy': { steps: ['Joint Owner Verification'], content: [
            { title: 'Joint Owner Verification', fields: [
              { label: 'Joint owner full name', type: 'input', placeholder: 'Full legal name' },
              { label: 'Joint owner SSN (last 4)', type: 'input', placeholder: '0000' },
              { label: 'Joint owner consent acknowledged', type: 'checkbox' },
            ]},
          ]},
          'Trust-owned': { steps: ['Trust Details', 'Trustee Verification'], content: [
            { title: 'Trust Details', fields: [
              { label: 'Trust name', type: 'input', placeholder: 'The Smith Family Trust' },
              { label: 'Trust EIN', type: 'input', placeholder: '00-0000000' },
              { label: 'Trust type', type: 'select', options: ['Selectâ€¦', 'Revocable', 'Irrevocable'] },
            ]},
            { title: 'Trustee Verification', fields: [
              { label: 'Trustee full name', type: 'input', placeholder: 'Full legal name' },
              { label: 'Trustee SSN (last 4)', type: 'input', placeholder: '0000' },
              { label: 'Trustee authority acknowledged', type: 'checkbox' },
            ]},
          ]},
        },
      },
      minor_branch: {
        afterBaseIndex: 2, triggerLabel: 'Beneficiary is a minor?',
        map: {
          'Yes â€” under 18': { steps: ['Guardian / Trustee'], content: [
            { title: 'Guardian or Trustee Information', fields: [
              { label: 'Guardian / Trustee full name', type: 'input', placeholder: 'Full legal name' },
              { label: 'Relationship to minor', type: 'select', options: ['Selectâ€¦', 'Parent', 'Legal guardian', 'Trustee'] },
              { label: 'UTMA / custodial account?', type: 'select', options: ['Selectâ€¦', 'No', 'Yes'] },
            ]},
          ]},
        },
      },
    },
  },

  file_claim: {
    label: 'File a Claim',
    icon: 'ğŸ—‚ï¸',
    baseSteps: ['Request Type', 'Policy Verification', 'Incident Details', 'Documentation', 'Review'],
    baseContent: [
      null,
      { title: 'Policy Verification', fields: [
        { label: 'Policy number', type: 'input', placeholder: 'POL-000000' },
        { label: 'Policy type', type: 'select', options: ['Selectâ€¦', 'Life', 'Annuity', 'Long-Term Care'] },
      ]},
      { title: 'Incident Details', fields: [
        { label: 'Date of incident', type: 'input', placeholder: 'MM/DD/YYYY' },
        { label: 'Claim type', type: 'branch-select', branchKey: 'claim_branch',
          options: ['Selectâ€¦', 'Death benefit', 'Disability', 'Long-term care event', 'Other'],
          hint: 'Claim type determines supplemental verification steps.' },
        { label: 'Brief description', type: 'input', placeholder: 'Describe the eventâ€¦' },
      ]},
      { title: 'Documentation Upload', fields: [
        { label: 'Supporting document type', type: 'select', options: ['Selectâ€¦', 'Death certificate', 'Medical records', 'Physician statement', 'Other'] },
        { label: 'Note: Upload your documents after submission via the portal', type: 'info' },
      ]},
      { title: 'Final Review', fields: [
        { label: 'All information provided is accurate to the best of my knowledge', type: 'checkbox' },
        { label: 'I authorize the release of relevant medical records', type: 'checkbox' },
      ]},
    ],
    branches: {
      claim_branch: {
        afterBaseIndex: 2, triggerLabel: 'Claim type',
        map: {
          'Death benefit': { steps: ['Claimant Info'], content: [
            { title: 'Claimant Information', fields: [
              { label: 'Claimant full name', type: 'input', placeholder: 'Full legal name' },
              { label: 'Relationship to insured', type: 'select', options: ['Selectâ€¦', 'Spouse', 'Child', 'Estate', 'Other'] },
              { label: 'Date of death', type: 'input', placeholder: 'MM/DD/YYYY' },
            ]},
          ]},
          'Disability': { steps: ['Medical Authorization'], content: [
            { title: 'Medical Authorization', fields: [
              { label: 'Treating physician name', type: 'input', placeholder: 'Dr. First Last' },
              { label: 'Diagnosis / condition', type: 'input', placeholder: 'Brief description' },
              { label: 'Authorization to release medical records acknowledged', type: 'checkbox' },
            ]},
          ]},
          'Long-term care event': { steps: ['Care Provider Info', 'Physician Statement'], content: [
            { title: 'Care Provider Information', fields: [
              { label: 'Care facility / provider name', type: 'input', placeholder: 'Provider or facility name' },
              { label: 'Care type', type: 'select', options: ['Selectâ€¦', 'In-home care', 'Assisted living', 'Nursing facility', 'Memory care'] },
              { label: 'Care start date', type: 'input', placeholder: 'MM/DD/YYYY' },
            ]},
            { title: 'Physician Statement', fields: [
              { label: 'Attending physician name', type: 'input', placeholder: 'Dr. First Last' },
              { label: 'Licensed in state', type: 'select', options: ['Select stateâ€¦', 'California', 'Texas', 'New York', 'Florida', 'Other'] },
              { label: 'Physician statement submitted', type: 'checkbox' },
            ]},
          ]},
        },
      },
    },
  },
};

/* â”€â”€â”€ Runtime state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let condPath    = null;
let condCurrent = 0;
let condPrev    = null;
// condSpawned[pathKey][branchKey] = { afterBaseIndex, steps[], content[], chosen } | null
const condSpawned = {};

/* â”€â”€â”€ Helper: merge baseSteps + active spawns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getEffectiveSteps(pathKey) {
  const path = COND_PATHS[pathKey];
  const spawns = condSpawned[pathKey] || {};
  const insertions = [];
  for (const [, sp] of Object.entries(spawns)) {
    if (sp) insertions.push({ abi: sp.afterBaseIndex, steps: sp.steps });
  }
  insertions.sort((a, b) => a.abi - b.abi);
  const result = [];
  path.baseSteps.forEach((lbl, bi) => {
    result.push({ label: lbl, isSpawned: false });
    insertions.filter(ins => ins.abi === bi).forEach(ins => {
      ins.steps.forEach(sl => result.push({ label: sl, isSpawned: true }));
    });
  });
  return result; // [{ label, isSpawned }]
}

/* â”€â”€â”€ Helper: get content def for effective index â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getEffectiveContent(pathKey, effIdx) {
  const path = COND_PATHS[pathKey];
  const spawns = condSpawned[pathKey] || {};
  const insertions = [];
  for (const [, sp] of Object.entries(spawns)) {
    if (sp) insertions.push({ abi: sp.afterBaseIndex, content: sp.content });
  }
  insertions.sort((a, b) => a.abi - b.abi);
  let idx = 0;
  for (let bi = 0; bi < path.baseSteps.length; bi++) {
    if (idx === effIdx) return { def: path.baseContent[bi], isSpawned: false };
    idx++;
    const insHere = insertions.filter(i => i.abi === bi);
    for (const ins of insHere) {
      for (const c of ins.content) {
        if (idx === effIdx) return { def: c, isSpawned: true };
        idx++;
      }
    }
  }
  return { def: null, isSpawned: false };
}

/* â”€â”€â”€ Apply a branch selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function applyBranch(pathKey, branchKey, chosen) {
  const branchDef = COND_PATHS[pathKey].branches[branchKey];
  if (!condSpawned[pathKey]) condSpawned[pathKey] = {};
  const spawnEntry = branchDef.map[chosen] || null;
  condSpawned[pathKey][branchKey] = spawnEntry
    ? { afterBaseIndex: branchDef.afterBaseIndex, steps: spawnEntry.steps, content: spawnEntry.content, chosen }
    : null;
  // Show spawn banner if steps were added
  const banner = document.getElementById('cond-spawn-banner');
  const bannerText = document.getElementById('cond-spawn-banner-text');
  if (spawnEntry) {
    bannerText.textContent = `â‘‚ "${chosen}" added ${spawnEntry.steps.length} step${spawnEntry.steps.length > 1 ? 's' : ''} to this flow.`;
    banner.classList.remove('hidden');
    setTimeout(() => banner.classList.add('hidden'), 4000);
  } else {
    banner.classList.add('hidden');
  }
  renderCondTrack(pathKey);
  renderCondSpawnPill(pathKey);
  renderBranchMap(pathKey);
}

/* â”€â”€â”€ Render just the stepper track â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderCondTrack(pathKey) {
  const track = document.getElementById('cond-stepper-track');
  if (!pathKey) {
    track.innerHTML = `<div class="h-step is-current"><div class="h-step-inner"><div class="h-dot current"><span class="dot-normal"><span style="font-size:13px">1</span></span></div><span class="h-label" style="color:var(--gray-900);font-weight:700">Request Type</span></div></div>`;
    return;
  }
  const steps = getEffectiveSteps(pathKey);
  track.innerHTML = '';
  steps.forEach(({ label, isSpawned }, i) => {
    if (i > 0) {
      const line = document.createElement('div');
      line.className = 'h-connector' + (i <= condCurrent ? ' complete' : '') + (isSpawned ? ' spawned' : '');
      track.appendChild(line);
    }
    const isComplete = i < condCurrent;
    const isCurrent  = i === condCurrent;
    const isFuture   = i > condCurrent;
    let cls = 'h-step';
    if (isCurrent)  cls += ' is-current';
    if (isComplete) cls += ' is-complete';
    if (isFuture)   cls += ' is-future';
    if (isSpawned)  cls += ' is-spawned';
    const step = document.createElement('div');
    step.className = cls;
    const dotState = isComplete ? 'complete' : isCurrent ? 'current' : 'incomplete';
    const dotCls   = dotState + (isSpawned ? ' spawned' : '');
    const lColor   = isCurrent ? 'var(--gray-900)' : isComplete ? 'var(--gray-600)' : isSpawned ? '#4527A0' : 'var(--gray-400)';
    const lWeight  = isCurrent ? '700' : '400';
    step.innerHTML = `
      <div class="h-step-inner">
        <div class="h-dot ${dotCls}">
          <span class="dot-normal">${isComplete ? svgCheck() : `<span style="font-size:13px">${i+1}</span>`}</span>
        </div>
        <span class="h-label" style="color:${lColor};font-weight:${lWeight}">${label}</span>
      </div>`;
    track.appendChild(step);
  });
}

/* â”€â”€â”€ Render spawn pill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderCondSpawnPill(pathKey) {
  const pill = document.getElementById('cond-spawn-pill');
  const pillText = document.getElementById('cond-spawn-pill-text');
  if (!pathKey) { pill.classList.add('hidden'); return; }
  const spawns = condSpawned[pathKey] || {};
  const active = Object.values(spawns).filter(Boolean);
  if (active.length === 0) { pill.classList.add('hidden'); return; }
  const totalSpawned = active.reduce((sum, s) => sum + s.steps.length, 0);
  pillText.textContent = `â‘‚ ${totalSpawned} internal step${totalSpawned > 1 ? 's' : ''} added to this flow`;
  pill.classList.remove('hidden');
}

/* â”€â”€â”€ Render dynamic branch map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderBranchMap(pathKey) {
  const mapEl  = document.getElementById('cond-branch-map');
  const mapTag = document.getElementById('cond-map-tag');
  if (!pathKey) {
    mapEl.innerHTML = '<p style="font-size:13px;color:var(--gray-400)">No path selected yet. Choose a request type in Step 1 to populate this map.</p>';
    mapTag.textContent = 'Select a path to see internal branches';
    return;
  }
  const path = COND_PATHS[pathKey];
  const steps = getEffectiveSteps(pathKey);
  const spawns = condSpawned[pathKey] || {};
  mapTag.textContent = `${path.label} Â· ${steps.length} steps`;

  // Step chips row
  let chipsHtml = '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-bottom:24px">';
  steps.forEach(({ label, isSpawned }, i) => {
    if (i > 0) chipsHtml += '<span style="color:var(--gray-400);font-size:11px">â†’</span>';
    chipsHtml += `<span class="branch-map-step${isSpawned ? ' spawned' : ''}">${label}</span>`;
  });
  chipsHtml += '</div>';

  // Branch conditions table
  let branchRows = '';
  for (const [bKey, branchDef] of Object.entries(path.branches || {})) {
    const afterStep = path.baseSteps[branchDef.afterBaseIndex];
    const sp = spawns[bKey];
    branchRows += `
      <div style="margin-bottom:20px">
        <div style="font-size:12px;font-weight:700;color:var(--gray-500);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">
          â‘‚ ${branchDef.triggerLabel}
          <span style="font-weight:400;color:var(--gray-400)"> â€” triggered at ${afterStep}</span>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead>
            <tr style="background:#f7f7f7">
              <th style="text-align:left;padding:6px 10px;border:1px solid #e5e5e5;color:var(--gray-600)">Selection</th>
              <th style="text-align:left;padding:6px 10px;border:1px solid #e5e5e5;color:var(--gray-600)">Spawned steps</th>
              <th style="text-align:center;padding:6px 10px;border:1px solid #e5e5e5;color:var(--gray-600)">Active</th>
            </tr>
          </thead>
          <tbody>`;
    for (const [opt, spawnEntry] of Object.entries(branchDef.map)) {
      const isActive = sp && sp.chosen === opt;
      branchRows += `
            <tr style="background:${isActive ? '#EDE7FF' : 'white'}">
              <td style="padding:6px 10px;border:1px solid #e5e5e5;color:${isActive ? '#4527A0' : 'var(--gray-700)'};font-weight:${isActive ? 600 : 400}">${opt}</td>
              <td style="padding:6px 10px;border:1px solid #e5e5e5">
                ${spawnEntry.steps.map(s => `<span class="branch-map-step spawned" style="margin-right:4px">${s}</span>`).join('<span style="color:#B39DDB;font-size:11px">â†’</span>')}
              </td>
              <td style="padding:6px 10px;border:1px solid #e5e5e5;text-align:center">${isActive ? 'âœ…' : 'â€”'}</td>
            </tr>`;
    }
    // No-spawn row
    const noneActive = !sp;
    branchRows += `
            <tr style="background:${noneActive ? '#f7f7f7' : 'white'}">
              <td style="padding:6px 10px;border:1px solid #e5e5e5;color:var(--gray-500);font-style:italic" colspan="2">Other â€” no additional steps</td>
              <td style="padding:6px 10px;border:1px solid #e5e5e5;text-align:center">${noneActive ? 'âœ…' : 'â€”'}</td>
            </tr>
          </tbody>
        </table>
      </div>`;
  }
  mapEl.innerHTML = chipsHtml + branchRows;
}

/* â”€â”€â”€ Full stepper render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderCondStepper() {
  const content = document.getElementById('cond-step-content');
  const pathTag = document.getElementById('cond-path-tag');
  const pathLbl = document.getElementById('cond-path-label');
  const banner  = document.getElementById('cond-branch-banner');
  const nextBtn = document.getElementById('cond-next');
  const backBtn = document.getElementById('cond-back');

  // Update track
  renderCondTrack(condPath);

  // Path tag
  if (condPath) {
    pathLbl.textContent = COND_PATHS[condPath].label;
    pathTag.classList.remove('hidden');
  } else {
    pathTag.classList.add('hidden');
  }

  // Branch-change banner (top-level path changed)
  if (condPrev && condPrev !== condPath) {
    banner.classList.remove('hidden');
    setTimeout(() => banner.classList.add('hidden'), 3500);
  }
  condPrev = condPath;

  const effSteps = condPath ? getEffectiveSteps(condPath) : [{ label: 'Request Type', isSpawned: false }];
  const total    = effSteps.length;
  const isLast   = condPath && condCurrent === total - 1;

  backBtn.disabled = condCurrent === 0;
  nextBtn.disabled = condCurrent === 0 && !condPath;
  nextBtn.innerHTML = isLast
    ? `Submit <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><polyline points="4,10 8.5,14.5 16,6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`
    : `Next <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

  /* â”€â”€ Step 0: choice cards â”€â”€ */
  if (condCurrent === 0) {
    content.innerHTML = `
      <h4 style="font-size:14px;font-weight:700;color:var(--gray-900);margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--gray-200)">What do you need help with today?</h4>
      <div class="choice-grid">
        <div class="choice-card ${ condPath === 'new_policy' ? 'selected' : '' }" data-choice="new_policy">
          <div class="choice-icon">ğŸ“‹</div>
          <div class="choice-title">New Policy Application</div>
          <div class="choice-desc">Apply for a new life, annuity, or long-term care policy.</div>
        </div>
        <div class="choice-card ${ condPath === 'update_beneficiary' ? 'selected' : '' }" data-choice="update_beneficiary">
          <div class="choice-icon">ğŸ‘¤</div>
          <div class="choice-title">Update Beneficiary</div>
          <div class="choice-desc">Change or add a beneficiary on an existing policy.</div>
        </div>
        <div class="choice-card ${ condPath === 'file_claim' ? 'selected' : '' }" data-choice="file_claim">
          <div class="choice-icon">ğŸ—‚ï¸</div>
          <div class="choice-title">File a Claim</div>
          <div class="choice-desc">Submit a claim for a death benefit, disability, or care event.</div>
        </div>
      </div>`;
    content.querySelectorAll('.choice-card').forEach(card => {
      card.addEventListener('click', () => {
        const prev = condPath;
        condPath = card.dataset.choice;
        if (prev !== condPath) {
          condPrev = prev;
          // Clear spawns from previous path
          if (prev && condSpawned[prev]) {
            Object.keys(condSpawned[prev]).forEach(k => { condSpawned[prev][k] = null; });
          }
        }
        renderCondStepper();
        renderBranchMap(condPath);
      });
    });
    renderCondSpawnPill(condPath);
    renderBranchMap(condPath);
    document.getElementById('cond-inline-msg').style.display = 'none';
    return;
  }

  /* â”€â”€ Steps 1+: form content â”€â”€ */
  const { def: stepDef, isSpawned } = getEffectiveContent(condPath, condCurrent);
  if (!stepDef) { content.innerHTML = ''; return; }

  // Retrieve saved branch-select values for this path
  const savedSelects = (condSpawned[condPath] && Object.values(condSpawned[condPath])) || [];

  let fieldsHtml = '';
  (stepDef.fields || []).forEach(f => {
    if (f.type === 'checkbox') {
      fieldsHtml += `<div class="cond-field-row"><label style="display:flex;align-items:center;gap:9px;font-size:14px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px;accent-color:var(--blue-primary)">${f.label}</label></div>`;
    } else if (f.type === 'branch-select') {
      // Find currently chosen value for this branch
      const sp = (condSpawned[condPath] || {})[f.branchKey];
      const chosenVal = sp ? sp.chosen : null;
      const opts = f.options.map(o => `<option${o === chosenVal ? ' selected' : ''}>${o}</option>`).join('');
      const badgeHtml = `<span class="branch-trigger-tag">â‘‚ condition</span>`;
      fieldsHtml += `
        <div class="cond-field-row" style="border-left:3px solid #B39DDB;padding-left:10px;background:#FAF7FF;border-radius:0 6px 6px 0">
          <span class="cond-field-label">${f.label}${badgeHtml}</span>
          <select class="cond-field-select" data-branch-key="${f.branchKey}" style="border-color:#B39DDB">${opts}</select>
          <div style="font-size:11px;color:#7B52C8;margin-top:4px">${f.hint || ''}</div>
        </div>`;
    } else if (f.type === 'select') {
      const opts = f.options.map(o => `<option>${o}</option>`).join('');
      fieldsHtml += `<div class="cond-field-row"><span class="cond-field-label">${f.label}</span><select class="cond-field-select">${opts}</select></div>`;
    } else if (f.type === 'info') {
      fieldsHtml += `<div style="padding:10px 14px;background:#F0F5FF;border-radius:6px;font-size:13px;color:var(--gray-600);margin-bottom:8px">â„¹ï¸ ${f.label}</div>`;
    } else {
      fieldsHtml += `<div class="cond-field-row"><span class="cond-field-label">${f.label}</span><input type="text" class="cond-field-input" placeholder="${f.placeholder || ''}"></div>`;
    }
  });

  const spawnBadge = isSpawned ? `<span class="branch-trigger-tag" style="margin-left:8px;font-size:10px;background:#EDE7FF;border-color:#B39DDB;color:#4527A0">â‘‚ sub-path step</span>` : '';
  content.innerHTML = `<h4 style="${isSpawned ? 'color:#4527A0' : ''}">${stepDef.title}${spawnBadge}</h4>${fieldsHtml}`;

  // Wire branch-select changes
  content.querySelectorAll('select[data-branch-key]').forEach(sel => {
    sel.addEventListener('change', () => {
      const val = sel.value;
      const bKey = sel.dataset.branchKey;
      applyBranch(condPath, bKey, val);
    });
  });

  renderCondSpawnPill(condPath);
  renderBranchMap(condPath);
  document.getElementById('cond-inline-msg').style.display = 'none';
}

/* â”€â”€â”€ Nav buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('cond-next').addEventListener('click', () => {
  if (!condPath) {
    const msg = document.getElementById('cond-inline-msg');
    msg.style.cssText = 'display:block;background:#FFF3F3;border:1.5px solid #F44336;color:#B71C1C';
    msg.textContent = 'Please select a request type before continuing.';
    return;
  }
  const total = getEffectiveSteps(condPath).length;
  if (condCurrent === total - 1) {
    const msg = document.getElementById('cond-inline-msg');
    msg.style.cssText = 'display:block;background:#E8F5E9;border:1.5px solid #4CAF50;color:#1B5E20';
    msg.textContent = 'âœ… Submitted successfully!';
    return;
  }
  condCurrent++;
  renderCondStepper();
});

document.getElementById('cond-back').addEventListener('click', () => {
  if (condCurrent === 0) return;
  condCurrent--;
  renderCondStepper();
});

renderCondStepper();
</script>
</body>
</html>
